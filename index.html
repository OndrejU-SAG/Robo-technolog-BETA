<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robo Technolog</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #ddd;
            transition: all 0.3s;
        }
        
        .section:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: block;
            padding: 15px 25px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1.05em;
        }
        
        .file-input-label:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .file-name {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
            text-align: center;
        }
        
        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .legend {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #ddd;
        }
        
        .legend h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 5px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }
        
        .color-green { background: #90EE90; }
        .color-yellow { background: #FFFF00; }
        .color-orange { background: #FFA500; }
        .color-red { background: #FF6B6B; }
        
        .processing {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Robo Technolog v2</h1>
        <p class="subtitle">Automatick√© dopl≈àov√°n√≠ artiklov√Ωch ƒç√≠sel</p>
        
        <!-- Master File Section -->
        <div class="section">
            <h2>üìö Vƒõdomostn√≠ z√°kladna (Master XLSX)</h2>
            <div class="file-input-wrapper">
                <input type="file" id="masterFile" accept=".xlsx,.xls" onchange="handleMasterFile(event)">
                <label for="masterFile" class="file-input-label">
                    üìÇ Nahr√°t Master soubor
                </label>
            </div>
            <div class="file-name" id="masterFileName"></div>
            <div id="masterStatus"></div>
            <button class="btn btn-danger" id="clearMasterBtn" onclick="clearMasterFile()" style="display:none; margin-top:15px;">
                üóëÔ∏è Smazat ulo≈æenou vƒõdomostn√≠ z√°kladnu
            </button>
        </div>
        
        <!-- User File Section -->
        <div class="section">
            <h2>üìÑ U≈æivatelsk√Ω soubor (XLSX k doplnƒõn√≠)</h2>
            <div class="file-input-wrapper">
                <input type="file" id="userFile" accept=".xlsx,.xls" onchange="handleUserFile(event)">
                <label for="userFile" class="file-input-label">
                    üìÇ Nahr√°t soubor k doplnƒõn√≠
                </label>
            </div>
            <div class="file-name" id="userFileName"></div>
            <button class="btn btn-primary" id="processBtn" onclick="processFile()" disabled>
                ‚öôÔ∏è Zpracovat a doplnit artikly
            </button>
        </div>
        
        <!-- Processing Animation -->
        <div class="processing" id="processingDiv">
            <div class="spinner"></div>
            <p>Zpracov√°v√°m data...</p>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" style="display:none;">
            <div class="status info" id="resultsInfo"></div>
        </div>
        
        <!-- Legend -->
        <div class="legend">
            <h3>üìä Legenda oznaƒçen√≠:</h3>
            <div class="legend-item">
                <div class="legend-color color-green"></div>
                <span><strong>P≈ôesn√© shody (100%):</strong> P≈ôesn√° shoda 1:1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-yellow"></div>
                <span><strong>Normalizovan√© (95%+):</strong> Rozd√≠l jen ve form√°tov√°n√≠, nul√°ch na zaƒç√°tku/konci, nebo prefixu.</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-orange"></div>
                <span><strong>Mal√© rozd√≠ly (80-94%):</strong> 1-2 jin√° p√≠smena/ƒç√≠sla</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-red"></div>
                <span><strong>ƒå√°steƒçn√°/nenalezeno (&lt;80%):</strong> Vƒõt≈°√≠ rozd√≠ly nebo nenalezeno</span>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <strong>‚ÑπÔ∏è V√≠cen√°sobn√© shody:</strong> Zobraz√≠ se v≈ædy a≈æ 3 nejlep≈°√≠ shody v samostatn√Ωch sloupc√≠ch.
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // M√çSTO PRO P≈òEDP≈òIPRAVEN√ù CSV MASTER LIST
        // ========================================
        // D≈ÆLE≈ΩIT√â: Kv≈Øli velk√©mu mno≈æstv√≠ dat a speci√°ln√≠m znak≈Øm
        // pou≈æ√≠vejte obyƒçejn√Ω string, ne template literal!
        // 
        // Form√°t: Ka≈æd√Ω ≈ô√°dek zakonƒçete \n a cel√© data dejte do '' nebo ""
        // P≈ô√≠klad:
        // const PREDEFINED_CSV = 'Typov√© oznaƒçen√≠;Artikl\n' +
        //     'RIT.123456;ART001\n' +
        //     'SE.789012;ART002\n' +
        //     'SIE.345678;ART003';
        //
        // NEBO m≈Ø≈æete pou≈æ√≠t loadPredefinedFromURL() n√≠≈æe
        // 
        // Nechte pr√°zdn√© ('') pokud nechcete pou≈æ√≠vat p≈ôedp≈ôipraven√° data
        
        const PREDEFINED_CSV = '';
        
        // ALTERNATIVA: Naƒç√≠st data z extern√≠ho souboru
        // Vytvo≈ôte soubor master-data.csv a dejte ho do stejn√© slo≈æky
        // Pak odkomentujte n√°sleduj√≠c√≠ ≈ô√°dek:
        // const PREDEFINED_CSV_URL = 'master-data.csv';
        const PREDEFINED_CSV_URL = 'master-data.csv';
        
        // ========================================
        
        let masterData = null;
        let userData = null;
        let usingPredefinedData = false;
        
        function parseCsvWithSemicolon(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(';').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // P≈ôeskoƒçit pr√°zdn√© ≈ô√°dky
                
                const values = line.split(';');
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] !== undefined ? values[index].trim() : '';
                });
                
                // P≈ôidat ≈ô√°dek i kdy≈æ m√° pr√°zdn√© typov√© oznaƒçen√≠
                data.push(row);
            }
            
            return data;
        }
        
        function loadPredefinedData() {
            // Pokud je zad√°na URL, naƒç√≠st z extern√≠ho souboru
            if (PREDEFINED_CSV_URL && PREDEFINED_CSV_URL.trim() !== '') {
                loadPredefinedFromURL();
                return true;
            }
            
            if (!PREDEFINED_CSV || PREDEFINED_CSV.trim() === '') {
                return false;
            }
            
            try {
                const data = parseCsvWithSemicolon(PREDEFINED_CSV);
                
                if (data.length === 0) {
                    console.warn('P≈ôedp≈ôipraven√° data jsou pr√°zdn√°');
                    return false;
                }
                
                const firstRow = data[0];
                if (!firstRow.hasOwnProperty('Typov√© oznaƒçen√≠') && !firstRow.hasOwnProperty('Artikl')) {
                    console.error('P≈ôedp≈ôipraven√° data nemaj√≠ po≈æadovan√© sloupce (Typov√© oznaƒçen√≠, Artikl)');
                    return false;
                }
                
                masterData = data;
                usingPredefinedData = true;
                
                document.getElementById('masterFileName').textContent = 'üìÑ P≈ôedp≈ôipraven√° data';
                document.getElementById('masterStatus').innerHTML = 
                    '<div class="status success">‚úÖ Pou≈æ√≠vaj√≠ se p≈ôedp≈ôipraven√° data (' + masterData.length + ' z√°znam≈Ø)</div>';
                document.getElementById('clearMasterBtn').style.display = 'block';
                
                console.log('P≈ôedp≈ôipraven√° data √∫spƒõ≈°nƒõ naƒçtena:', masterData.length, 'z√°znam≈Ø');
                console.log('Prvn√≠ 3 z√°znamy:', masterData.slice(0, 3));
                console.log('N√°zvy sloupc≈Ø:', Object.keys(masterData[0]));
                return true;
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ p≈ôedp≈ôipraven√Ωch dat:', error);
                alert('‚ö†Ô∏è Chyba p≈ôi naƒç√≠t√°n√≠ p≈ôedp≈ôipraven√Ωch dat: ' + error.message);
                return false;
            }
        }
        
        function loadPredefinedFromURL() {
            document.getElementById('masterStatus').innerHTML = 
                '<div class="status info">‚è≥ Naƒç√≠t√°m p≈ôedp≈ôipraven√° data ze souboru...</div>';
            
            fetch(PREDEFINED_CSV_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Soubor nenalezen: ' + PREDEFINED_CSV_URL);
                    }
                    return response.text();
                })
                .then(csvText => {
                    const data = parseCsvWithSemicolon(csvText);
                    
                    if (data.length === 0) {
                        throw new Error('Soubor je pr√°zdn√Ω');
                    }
                    
                    const firstRow = data[0];
                    if (!firstRow.hasOwnProperty('Typov√© oznaƒçen√≠') && !firstRow.hasOwnProperty('Artikl')) {
                        throw new Error('Soubor nem√° po≈æadovan√© sloupce (Typov√© oznaƒçen√≠, Artikl)');
                    }
                    
                    masterData = data;
                    usingPredefinedData = true;
                    
                    document.getElementById('masterFileName').textContent = 'üìÑ P≈ôedp≈ôipraven√° data (ze souboru)';
                    document.getElementById('masterStatus').innerHTML = 
                        '<div class="status success">‚úÖ Pou≈æ√≠vaj√≠ se p≈ôedp≈ôipraven√° data (' + masterData.length + ' z√°znam≈Ø)</div>';
                    document.getElementById('clearMasterBtn').style.display = 'block';
                    
                    checkReadyToProcess();
                    console.log('P≈ôedp≈ôipraven√° data √∫spƒõ≈°nƒõ naƒçtena ze souboru:', masterData.length, 'z√°znam≈Ø');
                    console.log('Prvn√≠ 3 z√°znamy:', masterData.slice(0, 3));
                    console.log('N√°zvy sloupc≈Ø:', Object.keys(masterData[0]));
                })
                .catch(error => {
                    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ze souboru:', error);
                    document.getElementById('masterStatus').innerHTML = 
                        '<div class="status warning">‚ö†Ô∏è Chyba p≈ôi naƒç√≠t√°n√≠: ' + error.message + '</div>';
                });
        }
        
        // Naƒç√≠st p≈ôedp≈ôipraven√° data p≈ôi startu
        window.addEventListener('load', function() {
            loadPredefinedData();
            checkReadyToProcess();
        });
        
        function handleMasterFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('masterFileName').textContent = 'üìÑ ' + file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Validate structure
                    if (jsonData.length === 0) {
                        alert('‚ùå Soubor je pr√°zdn√Ω!');
                        return;
                    }
                    
                    const firstRow = jsonData[0];
                    if (!firstRow['Typov√© oznaƒçen√≠'] && !firstRow['Typov\u0082¬© ozna\u00a3\u0082\u00be en\u00a3\u00ad']) {
                        alert('‚ùå Soubor mus√≠ obsahovat sloupec "Typov√© oznaƒçen√≠"!');
                        return;
                    }
                    
                    masterData = jsonData;
                    usingPredefinedData = false;
                    
                    document.getElementById('masterStatus').innerHTML = 
                        '<div class="status success">‚úÖ Master soubor √∫spƒõ≈°nƒõ nahr√°n (' + masterData.length + ' z√°znam≈Ø)</div>';
                    document.getElementById('clearMasterBtn').style.display = 'block';
                    
                    checkReadyToProcess();
                } catch (error) {
                    alert('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ souboru: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function clearMasterFile() {
            const message = usingPredefinedData 
                ? 'Opravdu chcete smazat p≈ôedp≈ôipraven√° data? Budete muset nahr√°t vlastn√≠ master soubor.'
                : 'Opravdu chcete smazat nahranou vƒõdomostn√≠ z√°kladnu?';
                
            if (confirm(message)) {
                masterData = null;
                usingPredefinedData = false;
                document.getElementById('masterFileName').textContent = '';
                document.getElementById('masterStatus').innerHTML = '';
                document.getElementById('clearMasterBtn').style.display = 'none';
                document.getElementById('masterFile').value = '';
                checkReadyToProcess();
            }
        }
        
        function handleUserFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('userFileName').textContent = 'üìÑ ' + file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    userData = {
                        workbook: workbook,
                        fileName: file.name
                    };
                    
                    checkReadyToProcess();
                } catch (error) {
                    alert('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ souboru: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function checkReadyToProcess() {
            const btn = document.getElementById('processBtn');
            if (masterData && userData) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }
        
        function removePrefix(str) {
            if (!str) return '';
            const strUpper = String(str).toUpperCase();
            const prefixes = ['RIT.', 'SE.', 'SIE.', 'PXC.', 'FES.', 'WAGO.', 'WEI.', 'PILZ.', 'ABB.', 'SCHNE.', 'PHO.', 'EATON.', 'SICK.'];
            
            for (let prefix of prefixes) {
                if (strUpper.startsWith(prefix)) {
                    return str.substring(prefix.length);
                }
            }
            return str;
        }
        
        function normalizeString(str) {
            // Odstranit form√°tovac√≠ znaky a p≈ôev√©st na velk√° p√≠smena
            return String(str).toUpperCase().replace(/[.\-_\s]/g, '');
        }
        
        function calculateSimilarity(userStr, masterStr) {
            // 1. P≈ôesn√° shoda 1:1
            if (userStr === masterStr) return 100;
            
            // Normalizovat oba ≈ôetƒõzce (odstranit form√°tov√°n√≠)
            const userNorm = normalizeString(userStr);
            const masterNorm = normalizeString(masterStr);
            
            // 2. Shoda po normalizaci (rozd√≠l jen ve form√°tov√°n√≠)
            if (userNorm === masterNorm) return 95;
            
            // 3. Kontrola chybƒõj√≠c√≠ch nul na zaƒç√°tku nebo konci
            // Odstranit vedouc√≠ nuly
            const userNoLeadZero = userNorm.replace(/^0+/, '');
            const masterNoLeadZero = masterNorm.replace(/^0+/, '');
            
            // Odstranit koncov√© nuly
            const userNoTrailZero = userNorm.replace(/0+$/, '');
            const masterNoTrailZero = masterNorm.replace(/0+$/, '');
            
            if (userNoLeadZero === masterNoLeadZero || 
                userNoTrailZero === masterNoTrailZero ||
                userNoLeadZero === masterNoTrailZero ||
                userNoTrailZero === masterNoLeadZero) {
                return 95;
            }
            
            // 4. Jedno jin√© ƒç√≠slo nebo p√≠smeno
            if (userNorm.length === masterNorm.length) {
                let differences = 0;
                for (let i = 0; i < userNorm.length; i++) {
                    if (userNorm[i] !== masterNorm[i]) {
                        differences++;
                    }
                }
                
                if (differences === 1) {
                    return 85; // Jedno jin√© p√≠smeno/ƒç√≠slo
                } else if (differences === 2) {
                    return 70; // Dvƒõ jin√° p√≠smena/ƒç√≠sla
                }
            }
            
            // 5. ƒå√°steƒçn√° shoda - Levenshteinova vzd√°lenost
            const maxLen = Math.max(userNorm.length, masterNorm.length);
            if (maxLen === 0) return 100;
            
            const distance = levenshteinDistance(userNorm, masterNorm);
            const similarity = ((maxLen - distance) / maxLen) * 100;
            
            return Math.round(similarity * 10) / 10;
        }
        
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        function removeSuffix(str) {
            if (!str) return '';
            // Odstran√≠ -Z X01, -ZY123 a podobn√© suffixy
            return String(str)
                .replace(/[-\s]Z\s+[A-Z0-9]+$/i, '')
                .replace(/[-\s]ZY\d+$/i, '')
                .trim();
        }
        
        function findMatch(userTyp) {
            if (!userTyp) return { 
                matches: [], 
                bestScore: 0, 
                matchType: 'red' 
            };
            
            const userTypStr = String(userTyp);
            
            // Debug: vypsat co hled√°me
            if (!masterData || masterData.length === 0) {
                console.error('Master data jsou pr√°zdn√°!');
                return { 
                    matches: [], 
                    bestScore: 0, 
                    matchType: 'red' 
                };
            }
            
            let allMatches = [];
            
            // Zjistit n√°zvy sloupc≈Ø z prvn√≠ho z√°znamu
            const firstRow = masterData[0];
            const columns = Object.keys(firstRow);
            
            // Naj√≠t sloupec s typov√Ωm oznaƒçen√≠m a artiklem
            const typColumn = columns.find(col => 
                col.toLowerCase().includes('typ') || 
                col.toLowerCase().includes('ozna') ||
                col === columns[0] // Prvn√≠ sloupec jako fallback
            ) || columns[0];
            
            const artiklColumn = columns.find(col => 
                col.toLowerCase().includes('artikl') ||
                col === columns[1] // Druh√Ω sloupec jako fallback
            ) || columns[1];
            
            for (let row of masterData) {
                const masterTyp = row[typColumn];
                const masterArtikl = row[artiklColumn];
                
                if (!masterTyp && !masterArtikl) continue; // P≈ôeskoƒçit pr√°zdn√© ≈ô√°dky
                
                const masterTypStr = String(masterTyp || '');
                
                let scores = [];
                
                // 1. P≈ô√≠m√© porovn√°n√≠
                const directScore = calculateSimilarity(userTypStr, masterTypStr);
                scores.push(directScore);
                
                // 2. Porovn√°n√≠ bez prefix≈Ø (SIE., PILZ., atd.)
                const userNoPref = removePrefix(userTypStr);
                const masterNoPref = removePrefix(masterTypStr);
                
                // Pokud se nƒõjak√Ω prefix skuteƒçnƒõ odstranil, d√°me 98%
                if (userNoPref !== userTypStr || masterNoPref !== masterTypStr) {
                    const noPrefScore = calculateSimilarity(userNoPref, masterNoPref);
                    if (noPrefScore === 100) {
                        scores.push(98); // P≈ôesn√° shoda po odstranƒõn√≠ prefixu
                    } else {
                        scores.push(noPrefScore);
                    }
                } else {
                    const noPrefScore = calculateSimilarity(userNoPref, masterNoPref);
                    scores.push(noPrefScore);
                }
                
                // 3. Kontrola s p≈ôid√°n√≠m bƒõ≈æn√Ωch prefix≈Ø
                const prefixes = ['RIT.', 'SE.', 'SIE.', 'PXC.', 'FES.', 'WAGO.', 'WEI.', 'PILZ.', 'ABB.', 'SCHNE.', 'PHO.', 'EATON.', 'SICK.'];
                for (let prefix of prefixes) {
                    const masterUpper = masterTypStr.toUpperCase();
                    if (masterUpper.startsWith(prefix)) {
                        const withPrefixScore = calculateSimilarity(prefix + userTypStr, masterTypStr);
                        if (withPrefixScore === 100) {
                            scores.push(98); // P≈ôesn√° shoda po p≈ôid√°n√≠ prefixu
                        } else {
                            scores.push(withPrefixScore);
                        }
                    }
                }
                
                // 4. Odstranƒõn√≠ suffix≈Ø (nap≈ô. -Z X01)
                const userNoSuffix = removeSuffix(userTypStr);
                const masterNoSuffix = removeSuffix(masterTypStr);
                if (userNoSuffix !== userTypStr || masterNoSuffix !== masterTypStr) {
                    const noSuffixScore = calculateSimilarity(userNoSuffix, masterNoSuffix);
                    scores.push(noSuffixScore);
                }
                
                const bestScore = Math.max(...scores);
                
                // P≈ôidat shody nad 40%
                if (bestScore >= 40) {
                    allMatches.push({
                        artikl: masterArtikl,
                        foundTyp: masterTyp,
                        score: Math.round(bestScore * 10) / 10
                    });
                }
            }
            
            // Se≈ôadit podle sk√≥re
            allMatches.sort((a, b) => b.score - a.score);
            
            // Odstranit duplicitn√≠ artikly
            const seen = new Set();
            allMatches = allMatches.filter(match => {
                if (seen.has(match.artikl)) return false;
                seen.add(match.artikl);
                return true;
            });
            
            // Vz√≠t maxim√°lnƒõ 3 nejlep≈°√≠
            const topMatches = allMatches.slice(0, 3);
            
            if (topMatches.length === 0) {
                return { 
                    matches: [], 
                    bestScore: 0, 
                    matchType: 'red' 
                };
            }
            
            const bestScore = topMatches[0].score;
            let matchType;
            if (bestScore === 100) matchType = 'green';
            else if (bestScore >= 95) matchType = 'yellow';
            else if (bestScore >= 80) matchType = 'orange';
            else matchType = 'red';
            
            return {
                matches: topMatches,
                bestScore: bestScore,
                matchType: matchType
            };
        }
        
        function processFile() {
            document.getElementById('processingDiv').style.display = 'block';
            document.getElementById('processBtn').disabled = true;
            
            setTimeout(() => {
                try {
                    const workbook = userData.workbook;
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {defval: ''});
                    
                    let stats = {
                        green: 0,
                        yellow: 0,
                        orange: 0,
                        red: 0
                    };
                    
                    // Process each row
                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const userTyp = row['Typov√© oznaƒçen√≠'] || row['Typov\u0082¬© ozna\u00a3\u0082\u00be en\u00a3\u00ad'];
                        
                        const matchResult = findMatch(userTyp);
                        
                        if (matchResult.matches.length > 0) {
                            // P≈ôidat samostatn√© sloupce pro ka≈ædou shodu
                            for (let j = 0; j < 3; j++) {
                                if (j < matchResult.matches.length) {
                                    const match = matchResult.matches[j];
                                    row[`Shoda ${j + 1} (%)`] = match.score;
                                    row[`Artikl ${j + 1}`] = match.artikl;
                                    row[`Nalezen√© typ. ozn. ${j + 1}`] = match.foundTyp;
                                } else {
                                    row[`Shoda ${j + 1} (%)`] = '';
                                    row[`Artikl ${j + 1}`] = '';
                                    row[`Nalezen√© typ. ozn. ${j + 1}`] = '';
                                }
                            }
                            row['_matchType'] = matchResult.matchType;
                        } else {
                            row['Shoda 1 (%)'] = 0;
                            row['Artikl 1'] = '';
                            row['Nalezen√© typ. ozn. 1'] = '';
                            row['Shoda 2 (%)'] = '';
                            row['Artikl 2'] = '';
                            row['Nalezen√© typ. ozn. 2'] = '';
                            row['Shoda 3 (%)'] = '';
                            row['Artikl 3'] = '';
                            row['Nalezen√© typ. ozn. 3'] = '';
                            row['_matchType'] = 'red';
                        }
                        
                        stats[matchResult.matchType]++;
                    }
                    
                    // Create new workbook with colors
                    const newWb = XLSX.utils.book_new();
                    const newWs = XLSX.utils.json_to_sheet(jsonData.map(row => {
                        const newRow = {...row};
                        delete newRow._matchType;
                        return newRow;
                    }));
                    
                    // Apply colors to entire rows
                    const range = XLSX.utils.decode_range(newWs['!ref']);
                    
                    for (let R = range.s.r + 1; R <= range.e.r; R++) {
                        const matchType = jsonData[R - 1]._matchType;
                        let fillColor;
                        
                        switch(matchType) {
                            case 'green': fillColor = '90EE90'; break;
                            case 'yellow': fillColor = 'FFFF00'; break;
                            case 'orange': fillColor = 'FFA500'; break;
                            case 'red': fillColor = 'FF6B6B'; break;
                        }
                        
                        if (fillColor) {
                            for (let C = range.s.c; C <= range.e.c; C++) {
                                const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                                if (!newWs[cellAddress]) {
                                    newWs[cellAddress] = {t: 's', v: ''};
                                }
                                if (!newWs[cellAddress].s) newWs[cellAddress].s = {};
                                newWs[cellAddress].s.fgColor = {rgb: fillColor};
                                newWs[cellAddress].s.fill = {
                                    patternType: 'solid',
                                    fgColor: {rgb: fillColor}
                                };
                            }
                        }
                    }
                    
                    XLSX.utils.book_append_sheet(newWb, newWs, 'Data');
                    
                    // Download
                    const fileName = userData.fileName.replace(/\.xlsx?$/i, '_doplneno.xlsx');
                    XLSX.writeFile(newWb, fileName, {cellStyles: true});
                    
                    // Show results
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('resultsInfo').innerHTML = 
                        `<strong>‚úÖ Soubor zpracov√°n a sta≈æen!</strong><br><br>` +
                        `üìä Statistika:<br>` +
                        `üü¢ P≈ôesn√© shody (100%): ${stats.green}<br>` +
                        `üü° Normalizovan√© (95%+): ${stats.yellow}<br>` +
                        `üü† Mal√© rozd√≠ly (80-94%): ${stats.orange}<br>` +
                        `üî¥ ƒå√°steƒçn√°/nenalezeno (&lt;80%): ${stats.red}`;
                    
                } catch (error) {
                    alert('‚ùå Chyba p≈ôi zpracov√°n√≠: ' + error.message);
                    console.error(error);
                } finally {
                    document.getElementById('processingDiv').style.display = 'none';
                    document.getElementById('processBtn').disabled = false;
                }
            }, 500);
        }
    </script>
</body>
</html>
