<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robo Technolog</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #ddd;
            transition: all 0.3s;
        }

        .section:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 15px 25px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1.05em;
        }

        .file-input-label:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .file-name {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
            text-align: center;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: #28a745;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .legend {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .legend h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 5px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        .color-green { background: #90EE90; }
        .color-yellow { background: #FFFF00; }
        .color-orange { background: #FFA500; }
        .color-red { background: #FF6B6B; }

        /* Material You Toggle Switch */
        .toggle-container {
            position: relative;
            display: inline-block;
        }

        .toggle-input {
            display: none;
        }

        .toggle-label {
            display: block;
            width: 60px;
            height: 30px;
            background: #667eea;
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-button {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-input:checked + .toggle-label {
            background: #28a745;
        }

        .toggle-label.effretikon {
            background: #dc3545 !important;
        }

        .toggle-input:checked + .toggle-label .toggle-button {
            transform: translateX(30px);
        }

        /* Enhanced toggle with labels */
        .toggle-with-labels {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f2ff;
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .toggle-option-label {
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 15px;
        }

        .toggle-option-label.active {
            color: white;
        }

        .toggle-option-label.inactive {
            color: #999;
        }

        .search-result {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
        }

        .result-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .result-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            position: relative;
        }

        .result-item.green { background: #90EE90; border-color: #5cb85c; }
        .result-item.yellow { background: #FFFF00; border-color: #f0ad4e; }
        .result-item.orange { background: #FFA500; border-color: #ff8c00; }
        .result-item.red { background: #FF6B6B; border-color: #d9534f; }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .result-label {
            font-weight: 600;
            color: #333;
        }

        .result-value {
            color: #555;
            text-align: right;
        }

        .google-search-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .google-search-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(66, 133, 244, 0.4);
        }

        .google-search-icon {
            cursor: pointer;
            color: #4285f4;
            font-size: 1.2em;
            margin-left: 8px;
            transition: all 0.3s;
        }

        .google-search-icon:hover {
            color: #3367d6;
            transform: scale(1.2);
        }

        .processing {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Robo Technolog</h1>
        <p class="subtitle">V2.4 pro automatick√© dopl≈àov√°n√≠ artiklov√Ωch ƒç√≠sel</p>

        <!-- Master File Section -->
        <div class="section">
            <h2>üìö Vƒõdomostn√≠ z√°kladna (Master XLSX)</h2>

            <!-- Database Toggle -->
            <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div class="toggle-with-labels">
                    <span class="toggle-option-label" id="ustiLabel" style="color: white; background: #28a745;">√öst√≠</span>
                    <div class="toggle-container">
                        <input type="checkbox" id="databaseToggle" class="toggle-input" onchange="updateDatabase()">
                        <label for="databaseToggle" class="toggle-label" id="databaseToggleLabel" style="background: #28a745;">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                    <span class="toggle-option-label inactive" id="effiLabel">Effretikon</span>
                </div>
            </div>

            <div class="file-input-wrapper">
                <input type="file" id="masterFile" accept=".xlsx,.xls" onchange="handleMasterFile(event)">
                <label for="masterFile" class="file-input-label">
                    üìÇ Nahr√°t Master soubor
                </label>
            </div>
            <div class="file-name" id="masterFileName"></div>
            <div id="masterStatus"></div>
            <button class="btn btn-danger" id="clearMasterBtn" onclick="clearMasterFile()" style="display:none; margin-top:15px;">
                üóëÔ∏è Smazat ulo≈æenou vƒõdomostn√≠ z√°kladnu
            </button>
        </div>

        <!-- Quick Search Section -->
        <div class="section">
            <h2>üîç Rychl√© vyhled√°v√°n√≠</h2>

            <!-- Mode Toggle -->
            <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div class="toggle-with-labels">
                    <span class="toggle-option-label" id="fuzzyLabel" style="color: white; background: #667eea;">Fuzzy Search</span>
                    <div class="toggle-container">
                        <input type="checkbox" id="searchModeToggle" class="toggle-input" onchange="updateSearchMode()">
                        <label for="searchModeToggle" class="toggle-label">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                    <span class="toggle-option-label inactive" id="completionLabel">Dopl≈àov√°n√≠</span>
                </div>
            </div>

            <!-- Search Field Selector -->
            <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <span style="font-weight: 600; color: #333;">Hledat v:</span>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 15px; background: #f0f2ff; border-radius: 8px; transition: all 0.3s;" onmouseover="this.style.background='#e0e4ff'" onmouseout="this.style.background='#f0f2ff'">
                    <input type="radio" name="searchField" value="typ" checked onchange="updateSearchField()" style="cursor: pointer;">
                    <span style="font-weight: 500;">Typov√© oznaƒçen√≠</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 15px; background: #f0f2ff; border-radius: 8px; transition: all 0.3s;" onmouseover="this.style.background='#e0e4ff'" onmouseout="this.style.background='#f0f2ff'">
                    <input type="radio" name="searchField" value="vyrobce" onchange="updateSearchField()" style="cursor: pointer;">
                    <span style="font-weight: 500;">V√Ωrobce</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 15px; background: #f0f2ff; border-radius: 8px; transition: all 0.3s;" onmouseover="this.style.background='#e0e4ff'" onmouseout="this.style.background='#f0f2ff'">
                    <input type="radio" name="searchField" value="nazev" onchange="updateSearchField()" style="cursor: pointer;">
                    <span style="font-weight: 500;">N√°zev</span>
                </label>
            </div>

            <div id="searchModeDescription" style="text-align: center; margin-bottom: 15px; padding: 10px; background: #f0f2ff; border-radius: 8px; font-size: 0.95em; color: #555;">
                üéØ Hled√° nejpodobnƒõj≈°√≠ shody, vrac√≠ top 3 v√Ωsledky
            </div>

            <input type="text" id="searchInput" placeholder="Zadejte typov√© oznaƒçen√≠ k vyhled√°n√≠..."
                   style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.05em; margin-bottom: 10px;"
                   onkeypress="if(event.key==='Enter') searchSingle()">
            <button class="btn btn-primary" id="searchBtn" onclick="searchSingle()" disabled>
                üîé Vyhledat artikl
            </button>

            <!-- Manufacturer Filter (only visible in completion mode after search) -->
            <div id="manufacturerFilter" style="display:none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 2px solid #ddd;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: 600; color: #333;">üè≠ Filtrovat podle v√Ωrobc≈Ø:</div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="selectAllManufacturers()" style="padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 500; transition: all 0.3s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">
                            ‚úì V≈°e
                        </button>
                        <button onclick="deselectAllManufacturers()" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 500; transition: all 0.3s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                            ‚úó Nic
                        </button>
                    </div>
                </div>
                <div id="manufacturerCheckboxes" style="display: flex; flex-wrap: wrap; gap: 5px;"></div> <!-- Reduced gap -->
                <button class="btn btn-primary" onclick="applyManufacturerFilter()" style="margin-top: 10px; padding: 10px 20px; font-size: 0.95em;">
                    ‚úì Pou≈æ√≠t filtr
                </button>
            </div>

            <div id="searchResults" style="display:none; margin-top: 20px;"></div>
        </div>

        <!-- User File Section -->
        <div class="section">
            <h2>üìÑ U≈æivatelsk√Ω soubor (XLSX k doplnƒõn√≠)</h2>
            <div class="file-input-wrapper">
                <input type="file" id="userFile" accept=".xlsx,.xls" onchange="handleUserFile(event)">
                <label for="userFile" class="file-input-label">
                    üìÇ Nahr√°t soubor k doplnƒõn√≠
                </label>
            </div>
            <div class="file-name" id="userFileName"></div>
            <button class="btn btn-primary" id="processBtn" onclick="processFile()" disabled>
                ‚öôÔ∏è Zpracovat a doplnit artikly
            </button>
        </div>

        <!-- Processing Animation -->
        <div class="processing" id="processingDiv">
            <div class="spinner"></div>
            <p>Zpracov√°v√°m data...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display:none;">
            <div class="status info" id="resultsInfo"></div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <h3>üìä Legenda oznaƒçen√≠:</h3>
            <div class="legend-item">
                <div class="legend-color color-green"></div>
                <span><strong>P≈ôesn√© shody (100%):</strong> P≈ôesn√° shoda 1:1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-yellow"></div>
                <span><strong>Normalizovan√© (95%+):</strong> Rozd√≠l jen ve form√°tov√°n√≠, nul√°ch na zaƒç√°tku/konci, nebo prefixu.</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-orange"></div>
                <span><strong>Mal√© rozd√≠ly (80-94%):</strong> 1-2 jin√° p√≠smena/ƒç√≠sla</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-red"></div>
                <span><strong>ƒå√°steƒçn√°/nenalezeno (&lt;80%):</strong> Vƒõt≈°√≠ rozd√≠ly nebo nenalezeno</span>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <strong>‚ÑπÔ∏è V√≠cen√°sobn√© shody:</strong> Zobraz√≠ se v≈ædy a≈æ 3 nejlep≈°√≠ shody v samostatn√Ωch sloupc√≠ch.
            </div>
        </div>
    </div>

    <script>
        const PREDEFINED_CSV = '';
        const PREDEFINED_CSV_URL = 'master-data.csv';
        const PREDEFINED_CSV_URL_EFFI = 'master-data-effi.csv';

        let masterData = null;
        let userData = null;
        let usingPredefinedData = false;
        let searchMode = 'fuzzy'; // 'fuzzy' or 'completion'
        let searchField = 'typ'; // 'typ', 'vyrobce', or 'nazev'
        let lastSearchResults = []; // Store last search results for filtering
        let selectedManufacturers = new Set(); // Store selected manufacturers
        let currentDatabase = 'usti'; // 'usti' or 'effretikon'

        function escapeAttr(s) {
            return String(s || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        function parseCsvWithSemicolon(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split(';').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = line.split(';');
                const row = {};
                headers.forEach((header, index) => {
                    const value = values[index] !== undefined ? values[index].trim() : '';
                    // Fix encoding issues with Czech characters
                    row[header] = fixCzechEncoding(value);
                });

                data.push(row);
            }

            return data;
        }

        function fixCzechEncoding(text) {
            if (!text) return text;

            // Remove all diacritics - convert accented characters to base characters
            const diacriticsMap = {
                '√°': 'a', '√Å': 'A', '√§': 'a', '√Ñ': 'A',
                'ƒç': 'c', 'ƒå': 'C', 'ƒá': 'c', 'ƒÜ': 'C',
                'ƒè': 'd', 'ƒé': 'D',
                '√©': 'e', '√â': 'E', 'ƒõ': 'e', 'ƒö': 'E', '√´': 'e', '√ã': 'E',
                '√≠': 'i', '√ç': 'I', '√Ø': 'i', '√è': 'I',
                '≈à': 'n', '≈á': 'N', '√±': 'n', '√ë': 'N',
                '√≥': 'o', '√ì': 'O', '√∂': 'o', '√ñ': 'O', '√¥': 'o', '√î': 'O',
                '≈ô': 'r', '≈ò': 'R',
                '≈°': 's', '≈†': 'S',
                '≈•': 't', '≈§': 'T',
                '√∫': 'u', '√ö': 'U', '≈Ø': 'u', '≈Æ': 'U', '√º': 'u', '√ú': 'U', '√π': 'u', '√ô': 'U',
                '√Ω': 'y', '√ù': 'Y', '√ø': 'y',
                '≈æ': 'z', '≈Ω': 'Z',
                '√ü': 'ss'
            };

            let fixed = text;
            for (let [accented, base] of Object.entries(diacriticsMap)) {
                fixed = fixed.replace(new RegExp(accented, 'g'), base);
            }

            return fixed;
        }

        function loadPredefinedData() {
            if (PREDEFINED_CSV_URL && PREDEFINED_CSV_URL.trim() !== '') {
                loadPredefinedFromURL();
                return true;
            }

            if (!PREDEFINED_CSV || PREDEFINED_CSV.trim() === '') {
                return false;
            }

            try {
                const data = parseCsvWithSemicolon(PREDEFINED_CSV);

                if (data.length === 0) {
                    console.warn('P≈ôedp≈ôipraven√° data jsou pr√°zdn√°');
                    return false;
                }

                const firstRow = data[0];
                if (!firstRow.hasOwnProperty('Typov√© oznaƒçen√≠') && !firstRow.hasOwnProperty('Artikl')) {
                    console.error('P≈ôedp≈ôipraven√° data nemaj√≠ po≈æadovan√© sloupce (Typov√© oznaƒçen√≠, Artikl)');
                    return false;
                }

                masterData = data;
                usingPredefinedData = true;

                document.getElementById('masterFileName').textContent = 'üìÑ P≈ôedp≈ôipraven√° data (neobsahuj√≠ artikly ve v√Ωbƒõhu a oznaƒçen√© k v√Ωmazu)';
                document.getElementById('masterStatus').innerHTML =
                    '<div class="status success">‚úÖ Pou≈æ√≠vaj√≠ se p≈ôedp≈ôipraven√° data -bez v√Ωbƒõh≈Ø a v√Ωmaz≈Ø  (' + masterData.length + ' z√°znam≈Ø)</div>';
                document.getElementById('clearMasterBtn').style.display = 'block';

                checkReadyToProcess();
                updateSearchButton();
                console.log('P≈ôedp≈ôipraven√° data √∫spƒõ≈°nƒõ naƒçtena:', masterData.length, 'z√°znam≈Ø');
                return true;
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ p≈ôedp≈ôipraven√Ωch dat:', error);
                alert('‚ö†Ô∏è Chyba p≈ôi naƒç√≠t√°n√≠ p≈ôedp≈ôipraven√Ωch dat: ' + error.message);
                return false;
            }
        }

        function loadPredefinedFromURL() {
            const csvUrl = currentDatabase === 'usti' ? PREDEFINED_CSV_URL : PREDEFINED_CSV_URL_EFFI;
            const dbName = currentDatabase === 'usti' ? '√öst√≠' : 'Effretikon';

            document.getElementById('masterStatus').innerHTML =
                '<div class="status info">‚è≥ Naƒç√≠t√°m p≈ôedp≈ôipraven√° data ze souboru...</div>';

            fetch(csvUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Soubor nenalezen: ' + csvUrl);
                    }
                    return response.text();
                })
                .then(csvText => {
                    const data = parseCsvWithSemicolon(csvText);

                    if (data.length === 0) {
                        throw new Error('Soubor je pr√°zdn√Ω');
                    }

                    const firstRow = data[0];
                    if (!firstRow.hasOwnProperty('Typov√© oznaƒçen√≠') && !firstRow.hasOwnProperty('Artikl')) {
                        throw new Error('Soubor nem√° po≈æadovan√© sloupce (Typov√© oznaƒçen√≠, Artikl)');
                    }

                    masterData = data;
                    usingPredefinedData = true;

                    document.getElementById('masterFileName').textContent = `üìÑ P≈ôedp≈ôipraven√° data (${dbName})`;
                    document.getElementById('masterStatus').innerHTML =
                        '<div class="status success">‚úÖ Pou≈æ√≠vaj√≠ se p≈ôedp≈ôipraven√° data (' + masterData.length + ' z√°znam≈Ø)</div>';
                    document.getElementById('clearMasterBtn').style.display = 'block';

                    checkReadyToProcess();
                    updateSearchButton();
                    console.log('P≈ôedp≈ôipraven√° data √∫spƒõ≈°nƒõ naƒçtena ze souboru:', masterData.length, 'z√°znam≈Ø');
                })
                .catch(error => {
                    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ze souboru:', error);
                    document.getElementById('masterStatus').innerHTML =
                        '<div class="status warning">‚ö†Ô∏è Chyba p≈ôi naƒç√≠t√°n√≠: ' + error.message + '</div>';
                });
        }

        window.addEventListener('load', function() {
            loadPredefinedData();
            checkReadyToProcess();
            updateSearchButton();
        });

        function updateSearchButton() {
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');

            if (masterData && searchInput.value.trim()) {
                searchBtn.disabled = false;
            } else {
                searchBtn.disabled = true;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', updateSearchButton);
            }
        });

        function updateSearchMode() {
            const toggle = document.getElementById('searchModeToggle');
            const modeDescription = document.getElementById('searchModeDescription');
            const searchInput = document.getElementById('searchInput');
            const fuzzyLabel = document.getElementById('fuzzyLabel');
            const completionLabel = document.getElementById('completionLabel');

            if (toggle.checked) {
                searchMode = 'completion';
                fuzzyLabel.className = 'toggle-option-label inactive';
                completionLabel.className = 'toggle-option-label active';
                completionLabel.style.color = 'white';
                completionLabel.style.background = '#28a745';
                fuzzyLabel.style.background = 'transparent';
                modeDescription.innerHTML = 'üìù Dopl≈àuje typov√© oznaƒçen√≠, vrac√≠ v≈°echny shody. Podporuje wildcard (*).';
                modeDescription.style.background = '#d4edda';
                updatePlaceholder();
            } else {
                searchMode = 'fuzzy';
                fuzzyLabel.className = 'toggle-option-label active';
                completionLabel.className = 'toggle-option-label inactive';
                fuzzyLabel.style.color = 'white';
                fuzzyLabel.style.background = '#667eea';
                completionLabel.style.background = 'transparent';
                modeDescription.innerHTML = 'üéØ Hled√° nejpodobnƒõj≈°√≠ shody, vrac√≠ top 3 v√Ωsledky';
                modeDescription.style.background = '#f0f2ff';
                updatePlaceholder();
            }
        }

        function updateSearchField() {
            const selected = document.querySelector('input[name="searchField"]:checked');
            if (selected) {
                searchField = selected.value;
                updatePlaceholder();
            }
        }

        function updatePlaceholder() {
            const searchInput = document.getElementById('searchInput');
            let fieldName = '';

            switch(searchField) {
                case 'typ':
                    fieldName = 'typov√© oznaƒçen√≠';
                    break;
                case 'vyrobce':
                    fieldName = 'v√Ωrobce';
                    break;
                case 'nazev':
                    fieldName = 'n√°zev';
                    break;
            }

            if (searchMode === 'completion') {
                searchInput.placeholder = `Nap≈ô: ${fieldName === 'typov√© oznaƒçen√≠' ? 'VX, *VX*50*, 2500.*' : fieldName === 'v√Ωrobce' ? 'WAGO, *SCHALTAG*' : 'Kanal*, *SROUB*'}`;
            } else {
                searchInput.placeholder = `Zadejte ${fieldName} k vyhled√°n√≠...`;
            }
        }

        function wildcardToRegex(pattern) {
            // Escape special regex characters except *
            const escaped = pattern.replace(/[.+?^${}()|[\]\\]/g, '\\$&');
            // Replace * with .*
            const regex = escaped.replace(/\*/g, '.*');
            return new RegExp(regex, 'i');
        }

        function searchCompletion(searchTerm) {
            if (!masterData) {
                return [];
            }

            const firstRow = masterData[0];
            const columns = Object.keys(firstRow);

            // Get column names
            const typColumn = columns.find(col =>
                col.toLowerCase().includes('typ') ||
                col.toLowerCase().includes('ozna')
            ) || columns[0];

            const artiklColumn = columns.find(col =>
                col.toLowerCase().includes('artikl')
            ) || columns[1];

            const vyrobceColumn = columns.find(col =>
                col.toLowerCase().includes('v√Ωrobce') ||
                col.toLowerCase().includes('vyrobce')
            ) || columns[2];

            const nazevColumn = columns.find(col =>
                col.toLowerCase().includes('n√°zev') ||
                col.toLowerCase().includes('nazev')
            ) || columns[3];

            let matches = [];

            // Determine which column to search in
            let searchColumn;
            switch(searchField) {
                case 'vyrobce':
                    searchColumn = vyrobceColumn;
                    break;
                case 'nazev':
                    searchColumn = nazevColumn;
                    break;
                case 'typ':
                default:
                    searchColumn = typColumn;
                    break;
            }

            // Check if wildcard is used
            const hasWildcard = searchTerm.includes('*');

            if (hasWildcard) {
                const regex = wildcardToRegex(searchTerm);

                for (let row of masterData) {
                    const searchValue = String(row[searchColumn] || '');

                    if (regex.test(searchValue)) {
                        matches.push({
                            artikl: row[artiklColumn],
                            foundTyp: row[typColumn],
                            vyrobce: row[vyrobceColumn] || 'N/A',
                            nazev: row[nazevColumn] || 'N/A',
                            score: 100
                        });
                    }
                }
            } else {
                // Simple contains search
                const searchUpper = searchTerm.toUpperCase();

                for (let row of masterData) {
                    const searchValue = String(row[searchColumn] || '');
                    const searchValueUpper = searchValue.toUpperCase();

                    if (searchValueUpper.includes(searchUpper)) {
                        matches.push({
                            artikl: row[artiklColumn],
                            foundTyp: row[typColumn],
                            vyrobce: row[vyrobceColumn] || 'N/A',
                            nazev: row[nazevColumn] || 'N/A',
                            score: 100
                        });
                    }
                }
            }

            return matches;
        }

        function openGoogleSearch(query) {
            const q = encodeURIComponent(String(query || '').trim() || document.getElementById('searchInput').value.trim());
            if (!q) return;
            const url = 'https://aistudio.google.com/app?prompt=' + q;
            window.open(url, '_blank');
        }

        function openGoogleSearchFromEl(el) {
            const q = el && el.dataset && el.dataset.query ? el.dataset.query : document.getElementById('searchInput').value.trim();
            openGoogleSearch(q);
        }

        function searchSingle() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim();

            if (!searchTerm) {
                alert('‚ö†Ô∏è Zadejte typov√© oznaƒçen√≠ k vyhled√°n√≠');
                return;
            }

            if (!masterData) {
                alert('‚ö†Ô∏è Nejprve nahrajte master soubor');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.style.display = 'block';

            if (searchMode === 'completion') {
                // Completion mode
                const matches = searchCompletion(searchTerm);
                lastSearchResults = matches; // Store for filtering

                if (matches.length === 0) {
                    document.getElementById('manufacturerFilter').style.display = 'none';
                    renderNoResults(searchTerm);
                    return;
                }

                // Show manufacturer filter
                showManufacturerFilter(matches);

                // Display all results initially
                displayCompletionResults(matches, searchTerm);

            } else {
                // Fuzzy search mode (original)
                document.getElementById('manufacturerFilter').style.display = 'none';
                const matchResult = findMatch(searchTerm);

                if (matchResult.matches.length === 0) {
                    renderNoResults(searchTerm);
                    return;
                }

                let html = `
                    <div class="search-result">
                        <div class="result-header">üîç V√Ωsledky vyhled√°v√°n√≠: "${escapeAttr(searchTerm)}"</div>
                `;

                matchResult.matches.forEach((match, index) => {
                    let colorClass;
                    if (match.score === 100) colorClass = 'green';
                    else if (match.score >= 95) colorClass = 'yellow';
                    else if (match.score >= 80) colorClass = 'orange';
                    else colorClass = 'red';

                    let matchIcon;
                    if (match.score === 100) matchIcon = '‚úÖ';
                    else if (match.score >= 95) matchIcon = '‚ö†Ô∏è';
                    else if (match.score >= 80) matchIcon = 'üî∂';
                    else matchIcon = '‚ùå';

                    html += `
                        <div class="result-item ${colorClass}">
                            <div class="result-row">
                                <span class="result-label">${matchIcon} Shoda ${index + 1}:</span>
                                <span class="result-value">${match.score}%</span>
                            </div>
                            <div class="result-row">
                                <span class="result-label">üì¶ Artikl:</span>
                                <span class="result-value"><strong>${escapeAttr(match.artikl || 'N/A')}</strong></span>
                            </div>
                            <div class="result-row">
                                <span class="result-label">üè∑Ô∏è Typov√© oznaƒçen√≠:</span>
                                <span class="result-value">${escapeAttr(match.foundTyp || 'N/A')}<span class="google-search-icon" data-query="${escapeAttr(match.foundTyp || '')}" onclick="openGoogleSearchFromEl(this)">üîç</span></span>
                            </div>
                            <div class="result-row">
                                <span class="result-label">üè≠ V√Ωrobce:</span>
                                <span class="result-value">${escapeAttr(match.vyrobce || 'N/A')}</span>
                            </div>
                            <div class="result-row">
                                <span class="result-label">üìù N√°zev:</span>
                                <span class="result-value">${escapeAttr(match.nazev || 'N/A')}</span>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                resultsDiv.innerHTML = html;
            }
        }

        function renderNoResults(searchTerm) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'search-result';
            const header = document.createElement('div');
            header.className = 'result-header';
            header.textContent = `üîç Hled√°n√≠: "${searchTerm}"`;

            const card = document.createElement('div');
            card.className = 'result-item red';

            const row = document.createElement('div');
            row.className = 'result-row';
            const label = document.createElement('span');
            label.className = 'result-label';
            label.textContent = '‚ùå Nenalezena ≈æ√°dn√° shoda';
            row.appendChild(label);
            card.appendChild(row);

            const btn = document.createElement('button');
            btn.className = 'google-search-btn';
            btn.textContent = 'üîç Hledat pomoc√≠ Google AI';
            btn.addEventListener('click', () => openGoogleSearch(searchTerm));
            card.appendChild(btn);

            container.appendChild(header);
            container.appendChild(card);
            resultsDiv.appendChild(container);
        }

        function showManufacturerFilter(matches) {
            // Get unique manufacturers
            const manufacturers = new Set();
            matches.forEach(match => {
                if (match.vyrobce && match.vyrobce !== 'N/A') {
                    manufacturers.add(match.vyrobce);
                }
            });

            // Initialize all manufacturers as selected
            selectedManufacturers = new Set(manufacturers);

            const filterDiv = document.getElementById('manufacturerFilter');
            const checkboxesDiv = document.getElementById('manufacturerCheckboxes');

            if (manufacturers.size === 0) {
                filterDiv.style.display = 'none';
                return;
            }

            filterDiv.style.display = 'block';
            checkboxesDiv.innerHTML = '';

            // Sort manufacturers alphabetically
            const sortedManufacturers = Array.from(manufacturers).sort();

            sortedManufacturers.forEach(manufacturer => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 3px; cursor: pointer; padding: 5px 8px; background: white; border-radius: 6px; border: 1px solid #ddd; transition: all 0.3s; font-size: 0.85em;'; // Smaller styles
                label.onmouseover = () => label.style.background = '#f0f2ff';
                label.onmouseout = () => label.style.background = 'white';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.value = manufacturer;
                checkbox.style.cursor = 'pointer';
                checkbox.onchange = (e) => {
                    if (e.target.checked) {
                        selectedManufacturers.add(manufacturer);
                    } else {
                        selectedManufacturers.delete(manufacturer);
                    }
                };

                const span = document.createElement('span');
                span.textContent = manufacturer;
                span.style.fontWeight = '500';

                label.appendChild(checkbox);
                label.appendChild(span);
                checkboxesDiv.appendChild(label);
            });
        }

        function applyManufacturerFilter() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim();

            // Filter results based on selected manufacturers
            const filteredResults = lastSearchResults.filter(match => {
                return selectedManufacturers.has(match.vyrobce) || match.vyrobce === 'N/A';
            });

            displayCompletionResults(filteredResults, searchTerm);
        }

        function selectAllManufacturers() {
            const checkboxes = document.querySelectorAll('#manufacturerCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedManufacturers.add(checkbox.value);
            });
        }

        function deselectAllManufacturers() {
            const checkboxes = document.querySelectorAll('#manufacturerCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                selectedManufacturers.delete(checkbox.value);
            });
        }

        function updateDatabase() {
            const toggle = document.getElementById('databaseToggle');
            const toggleLabel = document.getElementById('databaseToggleLabel');

            if (toggle.checked) {
                currentDatabase = 'effretikon';
                // visual update
                toggleLabel.classList.add('effretikon');
                document.getElementById('ustiLabel').style.background = 'transparent';
                document.getElementById('ustiLabel').style.color = '#999';
                document.getElementById('effiLabel').className = 'toggle-option-label active';
                document.getElementById('effiLabel').style.background = '#dc3545';
                document.getElementById('effiLabel').style.color = 'white';
            } else {
                currentDatabase = 'usti';
                toggleLabel.classList.remove('effretikon');
                document.getElementById('ustiLabel').className = 'toggle-option-label active';
                document.getElementById('ustiLabel').style.background = '#28a745';
                document.getElementById('ustiLabel').style.color = 'white';
                document.getElementById('effiLabel').className = 'toggle-option-label inactive';
                document.getElementById('effiLabel').style.background = 'transparent';
                document.getElementById('effiLabel').style.color = '#999';
            }

            // Clear current data and reload with new database if using predefined data
            if (usingPredefinedData) {
                masterData = null;
                loadPredefinedData();
            }
        }

        function displayCompletionResults(matches, searchTerm) {
            const resultsDiv = document.getElementById('searchResults');

            if (matches.length === 0) {
                resultsDiv.innerHTML = '';
                const container = document.createElement('div');
                container.className = 'search-result';
                const header = document.createElement('div');
                header.className = 'result-header';
                header.textContent = `üîç V√Ωsledky dopl≈àov√°n√≠: "${searchTerm}" (0 v√Ωsledk≈Ø)`;
                const card = document.createElement('div');
                card.className = 'result-item red';
                const row = document.createElement('div');
                row.className = 'result-row';
                const label = document.createElement('span');
                label.className = 'result-label';
                label.textContent = '‚ùå ≈Ω√°dn√© v√Ωsledky pro vybran√© v√Ωrobce';
                row.appendChild(label);
                card.appendChild(row);
                const btn = document.createElement('button');
                btn.className = 'google-search-btn';
                btn.textContent = 'üîç Hledat pomoc√≠ Google AI';
                btn.addEventListener('click', () => openGoogleSearch(searchTerm));
                card.appendChild(btn);
                container.appendChild(header);
                container.appendChild(card);
                resultsDiv.appendChild(container);
                return;
            }

            let html = `
                <div class="search-result">
                    <div class="result-header">üîç V√Ωsledky dopl≈àov√°n√≠: "${escapeAttr(searchTerm)}" (${matches.length} ${matches.length === 1 ? 'v√Ωsledek' : matches.length < 5 ? 'v√Ωsledky' : 'v√Ωsledk≈Ø'})</div>
            `;

            matches.forEach((match, index) => {
                html += `
                    <div class="result-item green">
                        <div class="result-row">
                            <span class="result-label">‚úÖ V√Ωsledek ${index + 1}:</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üì¶ Artikl:</span>
                            <span class="result-value"><strong>${escapeAttr(match.artikl || 'N/A')}</strong></span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üè∑Ô∏è Typov√© oznaƒçen√≠:</span>
                            <span class="result-value">${escapeAttr(match.foundTyp || 'N/A')}<span class="google-search-icon" data-query="${escapeAttr(match.foundTyp || '')}" onclick="openGoogleSearchFromEl(this)">üîç</span></span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üè≠ V√Ωrobce:</span>
                            <span class="result-value">${escapeAttr(match.vyrobce || 'N/A')}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üìù N√°zev:</span>
                            <span class="result-value">${escapeAttr(match.nazev || 'N/A')}</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function handleMasterFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('masterFileName').textContent = 'üìÑ ' + file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        alert('‚ùå Soubor je pr√°zdn√Ω!');
                        return;
                    }

                    // Fix Czech encoding in all string values
                    jsonData.forEach(row => {
                        Object.keys(row).forEach(key => {
                            if (typeof row[key] === 'string') {
                                row[key] = fixCzechEncoding(row[key]);
                            }
                        });
                    });

                    const firstRow = jsonData[0];
                    if (!firstRow['Typov√© oznaƒçen√≠'] && !firstRow['Typov\u0082¬© ozna\u00a3\u0082¬æ en\u00a3¬≠']) {
                        alert('‚ùå Soubor mus√≠ obsahovat sloupec "Typov√© oznaƒçen√≠"!');
                        return;
                    }

                    masterData = jsonData;
                    usingPredefinedData = false;

                    document.getElementById('masterStatus').innerHTML =
                        '<div class="status success">‚úÖ Master soubor √∫spƒõ≈°nƒõ nahr√°n (' + masterData.length + ' z√°znam≈Ø)</div>';
                    document.getElementById('clearMasterBtn').style.display = 'block';

                    checkReadyToProcess();
                    updateSearchButton();
                } catch (error) {
                    alert('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ souboru: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function clearMasterFile() {
            const message = usingPredefinedData
                ? 'Opravdu chcete smazat p≈ôedp≈ôipraven√° data? Budete muset nahr√°t vlastn√≠ master soubor.'
                : 'Opravdu chcete smazat nahranou vƒõdomostn√≠ z√°kladnu?';

            if (confirm(message)) {
                masterData = null;
                usingPredefinedData = false;
                document.getElementById('masterFileName').textContent = '';
                document.getElementById('masterStatus').innerHTML = '';
                document.getElementById('clearMasterBtn').style.display = 'none';
                document.getElementById('masterFile').value = '';
                checkReadyToProcess();
                updateSearchButton();
            }
        }

        function handleUserFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('userFileName').textContent = 'üìÑ ' + file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});

                    userData = {
                        workbook: workbook,
                        fileName: file.name
                    };

                    checkReadyToProcess();
                } catch (error) {
                    alert('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ souboru: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function checkReadyToProcess() {
            const btn = document.getElementById('processBtn');
            if (masterData && userData) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function removePrefix(str) {
            if (!str) return '';
            const strUpper = String(str).toUpperCase();
            const prefixes = ['RIT.', 'SE.', 'SIE.', 'PXC.', 'FES.', 'WAGO.', 'WEI.', 'PILZ.', 'ABB.', 'SCHNE.', 'PHO.', 'EATON.', 'SICK.'];

            for (let prefix of prefixes) {
                if (strUpper.startsWith(prefix)) {
                    return str.substring(prefix.length);
                }
            }
            return str;
        }

        function normalizeString(str) {
            return String(str).toUpperCase().replace(/[.\-_\s]/g, '');
        }

        function calculateSimilarity(userStr, masterStr) {
            if (userStr === masterStr) return 100;

            const userNorm = normalizeString(userStr);
            const masterNorm = normalizeString(masterStr);

            if (userNorm === masterNorm) return 95;

            const userNoLeadZero = userNorm.replace(/^0+/, '');
            const masterNoLeadZero = masterNorm.replace(/^0+/, '');

            const userNoTrailZero = userNorm.replace(/0+$/, '');
            const masterNoTrailZero = masterNorm.replace(/0+$/, '');

            if (userNoLeadZero === masterNoLeadZero ||
                userNoTrailZero === masterNoTrailZero ||
                userNoLeadZero === masterNoTrailZero ||
                userNoTrailZero === masterNoLeadZero) {
                return 95;
            }

            if (userNorm.length === masterNorm.length) {
                let differences = 0;
                for (let i = 0; i < userNorm.length; i++) {
                    if (userNorm[i] !== masterNorm[i]) {
                        differences++;
                    }
                }

                if (differences === 1) {
                    return 85;
                } else if (differences === 2) {
                    return 70;
                }
            }

            const maxLen = Math.max(userNorm.length, masterNorm.length);
            if (maxLen === 0) return 100;

            const distance = levenshteinDistance(userNorm, masterNorm);
            const similarity = ((maxLen - distance) / maxLen) * 100;

            return Math.round(similarity * 10) / 10;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

        function removeSuffix(str) {
            if (!str) return '';
            return String(str)
                .replace(/[-\s]Z\s+[A-Z0-9]+$/i, '')
                .replace(/[-\s]ZY\d+$/i, '')
                .trim();
        }

        function findMatch(userTyp) {
            if (!userTyp) return {
                matches: [],
                bestScore: 0,
                matchType: 'red'
            };

            const userTypStr = String(userTyp);

            if (!masterData || masterData.length === 0) {
                console.error('Master data jsou pr√°zdn√°!');
                return {
                    matches: [],
                    bestScore: 0,
                    matchType: 'red'
                };
            }

            let allMatches = [];

            const firstRow = masterData[0];
            const columns = Object.keys(firstRow);

            const typColumn = columns.find(col =>
                col.toLowerCase().includes('typ') ||
                col.toLowerCase().includes('ozna')
            ) || columns[0];

            const artiklColumn = columns.find(col =>
                col.toLowerCase().includes('artikl')
            ) || columns[1];

            const vyrobceColumn = columns.find(col =>
                col.toLowerCase().includes('v√Ωrobce') ||
                col.toLowerCase().includes('vyrobce')
            ) || columns[2];

            const nazevColumn = columns.find(col =>
                col.toLowerCase().includes('n√°zev') ||
                col.toLowerCase().includes('nazev')
            ) || columns[3];

            // Determine which column to search in
            let searchColumn;
            switch(searchField) {
                case 'vyrobce':
                    searchColumn = vyrobceColumn;
                    break;
                case 'nazev':
                    searchColumn = nazevColumn;
                    break;
                case 'typ':
                default:
                    searchColumn = typColumn;
                    break;
            }

            for (let row of masterData) {
                const masterValue = row[searchColumn];
                const masterArtikl = row[artiklColumn];

                if (!masterValue && !masterArtikl) continue;

                const masterValueStr = String(masterValue || '');

                let scores = [];

                const directScore = calculateSimilarity(userTypStr, masterValueStr);
                scores.push(directScore);

                // Only apply prefix/suffix logic for typov√© oznaƒçen√≠
                if (searchField === 'typ') {
                    const userNoPref = removePrefix(userTypStr);
                    const masterNoPref = removePrefix(masterValueStr);

                    if (userNoPref !== userTypStr || masterNoPref !== masterValueStr) {
                        const noPrefScore = calculateSimilarity(userNoPref, masterNoPref);
                        if (noPrefScore === 100) {
                            scores.push(98);
                        } else {
                            scores.push(noPrefScore);
                        }
                    } else {
                        const noPrefScore = calculateSimilarity(userNoPref, masterNoPref);
                        scores.push(noPrefScore);
                    }

                    const prefixes = ['RIT.', 'SE.', 'SIE.', 'PXC.', 'FES.', 'WAGO.', 'WEI.', 'PILZ.', 'ABB.', 'SCHNE.', 'PHO.', 'EATON.', 'SICK.'];
                    for (let prefix of prefixes) {
                        const masterUpper = masterValueStr.toUpperCase();
                        if (masterUpper.startsWith(prefix)) {
                            const withPrefixScore = calculateSimilarity(prefix + userTypStr, masterValueStr);
                            if (withPrefixScore === 100) {
                                scores.push(98);
                            } else {
                                scores.push(withPrefixScore);
                            }
                        }
                    }

                    const userNoSuffix = removeSuffix(userTypStr);
                    const masterNoSuffix = removeSuffix(masterValueStr);
                    if (userNoSuffix !== userTypStr || masterNoSuffix !== masterValueStr) {
                        const noSuffixScore = calculateSimilarity(userNoSuffix, masterNoSuffix);
                        scores.push(noSuffixScore);
                    }
                }

                const bestScore = Math.max(...scores);

                if (bestScore >= 40) {
                    allMatches.push({
                        artikl: masterArtikl,
                        foundTyp: row[typColumn] || 'N/A',
                        vyrobce: row[vyrobceColumn] || 'N/A',
                        nazev: row[nazevColumn] || 'N/A',
                        score: Math.round(bestScore * 10) / 10
                    });
                }
            }

            allMatches.sort((a, b) => b.score - a.score);

            const seen = new Set();
            allMatches = allMatches.filter(match => {
                if (seen.has(match.artikl)) return false;
                seen.add(match.artikl);
                return true;
            });

            const topMatches = allMatches.slice(0, 3);

            if (topMatches.length === 0) {
                return {
                    matches: [],
                    bestScore: 0,
                    matchType: 'red'
                };
            }

            const bestScore = topMatches[0].score;
            let matchType;
            if (bestScore === 100) matchType = 'green';
            else if (bestScore >= 95) matchType = 'yellow';
            else if (bestScore >= 80) matchType = 'orange';
            else matchType = 'red';

            return {
                matches: topMatches,
                bestScore: bestScore,
                matchType: matchType
            };
        }

        function processFile() {
            document.getElementById('processingDiv').style.display = 'block';
            document.getElementById('processBtn').disabled = true;

            setTimeout(() => {
                try {
                    const workbook = userData.workbook;
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {defval: ''});

                    let stats = {
                        green: 0,
                        yellow: 0,
                        orange: 0,
                        red: 0
                    };

                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const userTyp = row['Typov√© oznaƒçen√≠'] || row['Typov\u0082¬© ozna\u00a3\u0082¬æ en\u00a3¬≠'];

                        const matchResult = findMatch(userTyp);

                        if (matchResult.matches.length > 0) {
                            for (let j = 0; j < 3; j++) {
                                if (j < matchResult.matches.length) {
                                    const match = matchResult.matches[j];
                                    row[`Shoda ${j + 1} (%)`] = match.score;
                                    row[`Artikl ${j + 1}`] = match.artikl;
                                    row[`Nalezen√© typ. ozn. ${j + 1}`] = match.foundTyp;
                                } else {
                                    row[`Shoda ${j + 1} (%)`] = '';
                                    row[`Artikl ${j + 1}`] = '';
                                    row[`Nalezen√© typ. ozn. ${j + 1}`] = '';
                                }
                            }
                            row['_matchType'] = matchResult.matchType;
                        } else {
                            row['Shoda 1 (%)'] = 0;
                            row['Artikl 1'] = '';
                            row['Nalezen√© typ. ozn. 1'] = '';
                            row['Shoda 2 (%)'] = '';
                            row['Artikl 2'] = '';
                            row['Nalezen√© typ. ozn. 2'] = '';
                            row['Shoda 3 (%)'] = '';
                            row['Artikl 3'] = '';
                            row['Nalezen√© typ. ozn. 3'] = '';
                            row['_matchType'] = 'red';
                        }

                        stats[matchResult.matchType]++;
                    }

                    const newWb = XLSX.utils.book_new();
                    const newWs = XLSX.utils.json_to_sheet(jsonData.map(row => {
                        const newRow = {...row};
                        delete newRow._matchType;
                        return newRow;
                    }));

                    const range = XLSX.utils.decode_range(newWs['!ref']);

                    for (let R = range.s.r + 1; R <= range.e.r; R++) {
                        const matchType = jsonData[R - 1]._matchType;
                        let fillColor;

                        switch(matchType) {
                            case 'green': fillColor = '90EE90'; break;
                            case 'yellow': fillColor = 'FFFF00'; break;
                            case 'orange': fillColor = 'FFA500'; break;
                            case 'red': fillColor = 'FF6B6B'; break;
                        }

                        if (fillColor) {
                            for (let C = range.s.c; C <= range.e.c; C++) {
                                const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                                if (!newWs[cellAddress]) {
                                    newWs[cellAddress] = {t: 's', v: ''};
                                }
                                if (!newWs[cellAddress].s) newWs[cellAddress].s = {};
                                newWs[cellAddress].s.fgColor = {rgb: fillColor};
                                newWs[cellAddress].s.fill = {
                                    patternType: 'solid',
                                    fgColor: {rgb: fillColor}
                                };
                            }
                        }
                    }

                    XLSX.utils.book_append_sheet(newWb, newWs, 'Data');

                    const fileName = userData.fileName.replace(/\.xlsx?$/i, '_doplneno.xlsx');
                    XLSX.writeFile(newWb, fileName, {cellStyles: true});

                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('resultsInfo').innerHTML =
                        `<strong>‚úÖ Soubor zpracov√°n a sta≈æen!</strong><br><br>` +
                        `üìä Statistika:<br>` +
                        `üü¢ P≈ôesn√© shody (100%): ${stats.green}<br>` +
                        `üü° Normalizovan√© (95%+): ${stats.yellow}<br>` +
                        `üü† Mal√© rozd√≠ly (80-94%): ${stats.orange}<br>` +
                        `üî¥ ƒå√°steƒçn√°/nenalezeno (&lt;80%): ${stats.red}`;

                } catch (error) {
                    alert('‚ùå Chyba p≈ôi zpracov√°n√≠: ' + error.message);
                    console.error(error);
                } finally {
                    document.getElementById('processingDiv').style.display = 'none';
                    document.getElementById('processBtn').disabled = false;
                }
            }, 500);
        }
    </script>
</body>
</html>
