<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robo Technolog</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        
        .dark-mode .container {
            background: #2d2d44;
            color: #e0e0e0;
        }
        
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 0;
            font-size: 2.5em;
            text-align: left;
        }
        
        .dark-mode h1 {
            color: #8b7cff;
        }
        
        .dark-mode-toggle {
            background: #f0f2ff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .dark-mode .dark-mode-toggle {
            background: #3d3d5c;
        }
        
        .dark-mode-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #ddd;
            transition: all 0.3s;
        }
        
        .dark-mode .section {
            background: #3d3d5c;
            border-color: #555;
        }
        
        .section.compact {
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .section.compact h2 {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .section:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }
        
        .dark-mode .section:hover {
            border-color: #8b7cff;
            background: #4a4a6a;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .dark-mode .section h2 {
            color: #e0e0e0;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: block;
            padding: 15px 25px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1.05em;
        }
        
        .file-input-label:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .file-name {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
            text-align: center;
        }
        
        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .legend {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #ddd;
        }
        
        .legend h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 5px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }
        
        .color-green { background: #90EE90; }
        .color-yellow { background: #FFFF00; }
        .color-orange { background: #FFA500; }
        .color-red { background: #FF6B6B; }
        .color-purple { background: #b8a3ff; border-color: #6d4aff; }
        
        /* Material You Toggle Switch */
        .toggle-container {
            position: relative;
            display: inline-block;
        }
        
        .toggle-input {
            display: none;
        }
        
        .toggle-label {
            display: block;
            width: 60px;
            height: 30px;
            background: #667eea;
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .toggle-button {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-input:checked + .toggle-label {
            background: #28a745;
        }
        
        .toggle-label.effretikon {
            background: #dc3545 !important;
        }
        
        .toggle-input:checked + .toggle-label .toggle-button {
            transform: translateX(30px);
        }
        
        /* Enhanced toggle with labels */
        .toggle-with-labels {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f2ff;
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .toggle-option-label {
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 15px;
        }
        
        .toggle-option-label.active {
            color: white;
        }
        
        .toggle-option-label.inactive {
            color: #999;
        }
        
        /* Three-state toggle */
        .three-state-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f2ff;
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .three-state-option {
            font-weight: 600;
            font-size: 0.95em;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }
        
        .three-state-option.active {
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .three-state-option.inactive {
            color: #999;
            background: transparent;
        }
        
        .three-state-option:hover {
            transform: translateY(-1px);
        }
        
        /* Search history */
        .search-history {
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
            font-size: 0.85em;
        }
        
        .dark-mode .search-history {
            background: #3d3d5c;
        }
        
        .history-item {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 4px 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            margin: 3px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .dark-mode .history-item {
            background: #4a4a6a;
            border-color: #666;
            color: #e0e0e0;
        }
        
        .history-item:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-1px);
        }
        
        .history-clear {
            color: #999;
            cursor: pointer;
            font-size: 0.75em;
            margin-left: 8px;
        }
        
        .history-clear:hover {
            color: #dc3545;
        }
        
        /* Copy button */
        .copy-btn {
            background: transparent;
            color: #667eea;
            border: 1px solid #667eea;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            padding: 0;
            cursor: pointer;
            font-size: 1em;
            margin-left: 6px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .copy-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }
        
        .copy-btn.copied {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        /* Highlight match */
        .highlight {
            background: rgba(255, 235, 59, 0.4);
            font-weight: 600;
            padding: 1px 3px;
            border-radius: 3px;
        }
        
        .dark-mode .highlight {
            background: rgba(109, 74, 255, 0.3);
            color: #e0e0e0;
        }
        
        .search-result {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
        }
        
        .result-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .result-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
        }
        
        .result-item.green { background: #90EE90; border-color: #5cb85c; }
        .result-item.yellow { background: #FFFF00; border-color: #f0ad4e; }
        .result-item.orange { background: #FFA500; border-color: #ff8c00; }
        .result-item.red { background: #FF6B6B; border-color: #d9534f; }
        .result-item.purple { background: #b8a3ff; border-color: #6d4aff; }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1em;
        }
        
        .result-label {
            font-weight: 600;
            color: #333;
        }
        
        .result-value {
            color: #555;
            text-align: right;
        }
        
        .google-search-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
        }
        
        .google-search-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(66, 133, 244, 0.4);
        }
        
        .google-icon {
            width: 18px;
            height: 18px;
            display: inline-block;
            background: white;
            border-radius: 3px;
            padding: 2px;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            line-height: 18px;
        }
        
        .google-mini-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 8px;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        
        .google-mini-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            border-color: #4285f4;
        }
        
        .google-logo-mini {
            font-weight: 700;
            font-size: 15px;
            font-family: 'Product Sans', Arial, sans-serif;
            background: linear-gradient(90deg, #4285f4 0%, #ea4335 25%, #fbbc05 50%, #34a853 75%, #4285f4 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .processing {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-controls">
            <h1>ü§ñ Robo Technolog</h1>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="P≈ôepnout tmav√Ω re≈æim">
                <span id="darkModeIcon">üåô</span>
            </button>
        </div>
        
        <!-- Master File Section -->
        <div class="section compact">
            <h2>üìö Vƒõdomostn√≠ z√°kladna</h2>
            
            <!-- Database Toggle -->
            <div style="margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div class="toggle-with-labels">
                    <span class="toggle-option-label" id="ustiLabel" style="color: white; background: #28a745;">√öst√≠</span>
                    <div class="toggle-container">
                        <input type="checkbox" id="databaseToggle" class="toggle-input" onchange="updateDatabase()">
                        <label for="databaseToggle" class="toggle-label" id="databaseToggleLabel" style="background: #28a745;">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                    <span class="toggle-option-label inactive" id="effiLabel">Effretikon</span>
                </div>
            </div>
            
            <div class="file-name" id="masterFileName" style="font-size: 0.85em;"></div>
            <div id="masterStatus" style="font-size: 0.85em;"></div>
            
            <details style="margin-top: 10px;">
                <summary style="cursor: pointer; font-weight: 600; color: #667eea; font-size: 0.9em;">‚öôÔ∏è Pokroƒçil√© mo≈ænosti</summary>
                <div style="margin-top: 10px;">
                    <div class="file-input-wrapper">
                        <input type="file" id="masterFile" accept=".xlsx,.xls" onchange="handleMasterFile(event)">
                        <label for="masterFile" class="file-input-label" style="padding: 10px 20px; font-size: 0.95em;">
                            üìÇ Nahr√°t vlastn√≠ Master soubor
                        </label>
                    </div>
                    <button class="btn btn-danger" id="clearMasterBtn" onclick="clearMasterFile()" style="display:none; margin-top:10px; padding: 10px 20px; font-size: 0.9em;">
                        üóëÔ∏è Smazat ulo≈æenou z√°kladnu
                    </button>
                </div>
            </details>
        </div>
        
        <!-- Quick Search Section -->
        <div class="section">
            <h2>üîç Rychl√© vyhled√°v√°n√≠</h2>
            
            <!-- Mode Toggle -->
            <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div class="three-state-toggle">
                    <span class="three-state-option inactive" id="fuzzyLabel" onclick="setSearchMode('fuzzy')">Fuzzy Search</span>
                    <span class="three-state-option active" id="combinedLabel" onclick="setSearchMode('combined')" style="background: #667eea; color: white;">Kombinovan√©</span>
                    <span class="three-state-option inactive" id="completionLabel" onclick="setSearchMode('completion')">Dopl≈àov√°n√≠</span>
                </div>
            </div>
            
            <!-- Search Field Selector -->
            <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <span style="font-weight: 600; color: #333;">Hledat v:</span>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 15px; background: #f0f2ff; border-radius: 8px; transition: all 0.3s;" onmouseover="this.style.background='#e0e4ff'" onmouseout="this.style.background='#f0f2ff'">
                    <input type="radio" name="searchField" value="typ" checked onchange="updateSearchField()" style="cursor: pointer;">
                    <span style="font-weight: 500;">Typov√© oznaƒçen√≠</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 15px; background: #f0f2ff; border-radius: 8px; transition: all 0.3s;" onmouseover="this.style.background='#e0e4ff'" onmouseout="this.style.background='#f0f2ff'">
                    <input type="radio" name="searchField" value="vyrobce" onchange="updateSearchField()" style="cursor: pointer;">
                    <span style="font-weight: 500;">V√Ωrobce</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 15px; background: #f0f2ff; border-radius: 8px; transition: all 0.3s;" onmouseover="this.style.background='#e0e4ff'" onmouseout="this.style.background='#f0f2ff'">
                    <input type="radio" name="searchField" value="nazev" onchange="updateSearchField()" style="cursor: pointer;">
                    <span style="font-weight: 500;">N√°zev</span>
                </label>
            </div>
            
            <div id="searchModeDescription" style="text-align: center; margin-bottom: 15px; padding: 10px; background: #f0f2ff; border-radius: 8px; font-size: 0.95em; color: #555;">
                üéØ Kombinuje fuzzy search a wildcard (*), vrac√≠ v≈°echny shody
            </div>
            
            <input type="text" id="searchInput" placeholder="Zadejte typov√© oznaƒçen√≠ k vyhled√°n√≠..." 
                   style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.05em; margin-bottom: 10px;"
                   onkeypress="if(event.key==='Enter') searchSingle()">
            <button class="btn btn-primary" id="searchBtn" onclick="searchSingle()" disabled>
                üîé Vyhledat artikl
            </button>
            
            <!-- Search History -->
            <div class="search-history" id="searchHistory">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-weight: 600; font-size: 0.85em; color: #666;">üìú Historie:</span>
                    <span class="history-clear" onclick="clearHistory()">Vymazat</span>
                </div>
                <div id="historyItems"></div>
            </div>
            
            <!-- Manufacturer Filter (only visible in completion mode after search) -->
            <div id="manufacturerFilter" style="display:none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 2px solid #ddd; font-size: 0.9em;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: 600; color: #333; font-size: 0.95em;">üè≠ Filtr v√Ωrobc≈Ø:</div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="selectAllManufacturers()" style="padding: 4px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em; font-weight: 500; transition: all 0.3s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">
                            ‚úì V≈°e
                        </button>
                        <button onclick="deselectAllManufacturers()" style="padding: 4px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em; font-weight: 500; transition: all 0.3s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                            ‚úó Nic
                        </button>
                    </div>
                </div>
                <div id="manufacturerCheckboxes" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                <button class="btn btn-primary" onclick="applyManufacturerFilter()" style="margin-top: 8px; padding: 8px 16px; font-size: 0.9em;">
                    ‚úì Pou≈æ√≠t filtr
                </button>
            </div>
            
            <div id="searchResults" style="display:none; margin-top: 20px;"></div>
        </div>
        
        <!-- User File Section -->
        <div class="section">
            <h2>üìÑ U≈æivatelsk√Ω soubor (XLSX k doplnƒõn√≠)</h2>
            <div class="file-input-wrapper">
                <input type="file" id="userFile" accept=".xlsx,.xls" onchange="handleUserFile(event)">
                <label for="userFile" class="file-input-label">
                    üìÇ Nahr√°t soubor k doplnƒõn√≠
                </label>
            </div>
            <div class="file-name" id="userFileName"></div>
            <button class="btn btn-primary" id="processBtn" onclick="processFile()" disabled>
                ‚öôÔ∏è Zpracovat a doplnit artikly
            </button>
        </div>
        
        <!-- Processing Animation -->
        <div class="processing" id="processingDiv">
            <div class="spinner"></div>
            <p>Zpracov√°v√°m data...</p>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" style="display:none;">
            <div class="status info" id="resultsInfo"></div>
        </div>
        
        <!-- Legend -->
        <div class="legend">
            <h3>üìä Legenda oznaƒçen√≠:</h3>
            <div class="legend-item">
                <div class="legend-color color-green"></div>
                <span><strong>P≈ôesn√© shody (100%):</strong> P≈ôesn√° shoda 1:1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-yellow"></div>
                <span><strong>Normalizovan√© (95%+):</strong> Rozd√≠l jen ve form√°tov√°n√≠, nul√°ch na zaƒç√°tku/konci, nebo prefixu.</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-orange"></div>
                <span><strong>Mal√© rozd√≠ly (80-94%):</strong> 1-2 jin√° p√≠smena/ƒç√≠sla</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-red"></div>
                <span><strong>ƒå√°steƒçn√°/nenalezeno (&lt;80%):</strong> Vƒõt≈°√≠ rozd√≠ly nebo nenalezeno</span>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <strong>‚ÑπÔ∏è V√≠cen√°sobn√© shody:</strong> Zobraz√≠ se v≈ædy a≈æ 3 nejlep≈°√≠ shody v samostatn√Ωch sloupc√≠ch.
            </div>
        </div>
    </div>

    <script>
        const PREDEFINED_CSV = '';
        const PREDEFINED_CSV_URL = 'master-data.csv';
        const PREDEFINED_CSV_URL_EFFI = 'master-data-effi.csv';
        
        let masterData = null;
        let userData = null;
        let usingPredefinedData = false;
        let searchMode = 'combined'; // 'fuzzy', 'completion', or 'combined'
        let searchField = 'typ'; // 'typ', 'vyrobce', or 'nazev'
        let lastSearchResults = []; // Store last search results for filtering
        let selectedManufacturers = new Set(); // Store selected manufacturers
        let currentDatabase = 'usti'; // 'usti' or 'effretikon'
        let searchHistory = []; // Store search history
        let currentSearchTerm = ''; // Store current search term for highlighting
        
        // Manufacturer synonyms
        const manufacturerSynonyms = {
            'SCHALTAG': ['SCHALTAG CZ', 'SCHALTAG'],
            'SCHALTAG CZ': ['SCHALTAG CZ', 'SCHALTAG'],
            'WAGO': ['WAGO', 'WAGO KONTAKTTECHNIK'],
            'SIEMENS': ['SIEMENS', 'SIE', 'SIE.'],
            'RITTAL': ['RITTAL', 'RIT', 'RIT.'],
            'PHOENIX': ['PHOENIX', 'PHO', 'PHO.', 'PHOENIX CONTACT'],
            'ABB': ['ABB', 'ABB STOTZ'],
            'SCHNEIDER': ['SCHNEIDER', 'SCHNE', 'SCHNE.', 'SCHNEIDER ELECTRIC'],
            'EATON': ['EATON', 'EATON MOELLER'],
            'SICK': ['SICK', 'SICK AG']
        };
        
        function parseCsvWithSemicolon(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(';').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(';');
                const row = {};
                headers.forEach((header, index) => {
                    const value = values[index] !== undefined ? values[index].trim() : '';
                    // Fix encoding issues with Czech characters
                    row[header] = fixCzechEncoding(value);
                });
                
                data.push(row);
            }
            
            return data;
        }
        
        function fixCzechEncoding(text) {
            if (!text) return text;
            
            // Remove all diacritics - convert accented characters to base characters
            const diacriticsMap = {
                '√°': 'a', '√Å': 'A', '√§': 'a', '√Ñ': 'A',
                'ƒç': 'c', 'ƒå': 'C', 'ƒá': 'c', 'ƒÜ': 'C',
                'ƒè': 'd', 'ƒé': 'D',
                '√©': 'e', '√â': 'E', 'ƒõ': 'e', 'ƒö': 'E', '√´': 'e', '√ã': 'E',
                '√≠': 'i', '√ç': 'I', '√Ø': 'i', '√è': 'I',
                '≈à': 'n', '≈á': 'N', '√±': 'n', '√ë': 'N',
                '√≥': 'o', '√ì': 'O', '√∂': 'o', '√ñ': 'O', '√¥': 'o', '√î': 'O',
                '≈ô': 'r', '≈ò': 'R',
                '≈°': 's', '≈†': 'S',
                '≈•': 't', '≈§': 'T',
                '√∫': 'u', '√ö': 'U', '≈Ø': 'u', '≈Æ': 'U', '√º': 'u', '√ú': 'U', '√π': 'u', '√ô': 'U',
                '√Ω': 'y', '√ù': 'Y', '√ø': 'y',
                '≈æ': 'z', '≈Ω': 'Z',
                '√ü': 'ss',
                // Fix common encoding issues first
                '√É¬°': 'a', '√É¬©': 'e', '√É¬≠': 'i', '√É¬≥': 'o', '√É¬∫': 'u', '√Ö¬Ø': 'u', '√É¬Ω': 'y',
                '√Ñ': 'c', '√Ñ‚Ä∫': 'e', '√Ö¬°': 's', '√Ö‚Ñ¢': 'r', '√Ö¬æ': 'z', '√Ñ': 'd', '√Ö¬•': 't', '√Ö': 'n',
                '√É': 'A', '√É‚Ä∞': 'E', '√É': 'I', '√É"': 'O', '√É≈°': 'U', '√Ö¬Æ': 'U', '√É': 'Y',
                '√Ñ': 'C', '√Ñ≈°': 'E', '√Ö ': 'S', '√ÖÀú': 'R', '√Ö¬Ω': 'Z', '√Ñ≈Ω': 'D', '√Ö¬§': 'T', '√Ö‚Ä°': 'N',
                '√É¬§': 'a', '√É¬∂': 'o', '√É¬º': 'u', '√É‚Äû': 'A', '√É‚Äì': 'O', '√É≈ì': 'U', '√É≈∏': 'ss'
            };
            
            let fixed = text;
            for (let [accented, base] of Object.entries(diacriticsMap)) {
                fixed = fixed.replace(new RegExp(accented, 'g'), base);
            }
            
            return fixed;
        }
        
        function loadPredefinedData() {
            if (PREDEFINED_CSV_URL && PREDEFINED_CSV_URL.trim() !== '') {
                loadPredefinedFromURL();
                return true;
            }
            
            if (!PREDEFINED_CSV || PREDEFINED_CSV.trim() === '') {
                return false;
            }
            
            try {
                const data = parseCsvWithSemicolon(PREDEFINED_CSV);
                
                if (data.length === 0) {
                    console.warn('P≈ôedp≈ôipraven√° data jsou pr√°zdn√°');
                    return false;
                }
                
                const firstRow = data[0];
                if (!firstRow.hasOwnProperty('Typov√© oznaƒçen√≠') && !firstRow.hasOwnProperty('Artikl')) {
                    console.error('P≈ôedp≈ôipraven√° data nemaj√≠ po≈æadovan√© sloupce (Typov√© oznaƒçen√≠, Artikl)');
                    return false;
                }
                
                masterData = data;
                usingPredefinedData = true;
                
                document.getElementById('masterFileName').textContent = 'üìÑ P≈ôedp≈ôipraven√° data (neobsahuj√≠ artikly ve v√Ωbƒõhu a oznaƒçen√© k v√Ωmazu)';
                document.getElementById('masterStatus').innerHTML = 
                    '<div class="status success">‚úÖ Pou≈æ√≠vaj√≠ se p≈ôedp≈ôipraven√° data -bez v√Ωbƒõh≈Ø a v√Ωmaz≈Ø  (' + masterData.length + ' z√°znam≈Ø)</div>';
                document.getElementById('clearMasterBtn').style.display = 'block';
                
                console.log('P≈ôedp≈ôipraven√° data √∫spƒõ≈°nƒõ naƒçtena:', masterData.length, 'z√°znam≈Ø');
                console.log('Prvn√≠ 3 z√°znamy:', masterData.slice(0, 3));
                console.log('N√°zvy sloupc≈Ø:', Object.keys(masterData[0]));
                return true;
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ p≈ôedp≈ôipraven√Ωch dat:', error);
                alert('‚ö†Ô∏è Chyba p≈ôi naƒç√≠t√°n√≠ p≈ôedp≈ôipraven√Ωch dat: ' + error.message);
                return false;
            }
        }
        
        function loadPredefinedFromURL() {
            const csvUrl = currentDatabase === 'usti' ? PREDEFINED_CSV_URL : PREDEFINED_CSV_URL_EFFI;
            const dbName = currentDatabase === 'usti' ? '√öst√≠ nad Labem' : 'Effretikon';
            
            document.getElementById('masterStatus').innerHTML = 
                '<div class="status info">‚è≥ Naƒç√≠t√°m p≈ôedp≈ôipraven√° data ze souboru...</div>';
            
            fetch(csvUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Soubor nenalezen: ' + csvUrl);
                    }
                    return response.text();
                })
                .then(csvText => {
                    const data = parseCsvWithSemicolon(csvText);
                    
                    if (data.length === 0) {
                        throw new Error('Soubor je pr√°zdn√Ω');
                    }
                    
                    const firstRow = data[0];
                    if (!firstRow.hasOwnProperty('Typov√© oznaƒçen√≠') && !firstRow.hasOwnProperty('Artikl')) {
                        throw new Error('Soubor nem√° po≈æadovan√© sloupce (Typov√© oznaƒçen√≠, Artikl)');
                    }
                    
                    masterData = data;
                    usingPredefinedData = true;
                    
                    document.getElementById('masterFileName').textContent = `üìÑ P≈ôedp≈ôipraven√° data (${dbName})`;
                    document.getElementById('masterStatus').innerHTML = 
                        '<div class="status success">‚úÖ Pou≈æ√≠vaj√≠ se p≈ôedp≈ôipraven√° data (' + masterData.length + ' z√°znam≈Ø)</div>';
                    document.getElementById('clearMasterBtn').style.display = 'block';
                    
                    checkReadyToProcess();
                    updateSearchButton();
                    console.log('P≈ôedp≈ôipraven√° data √∫spƒõ≈°nƒõ naƒçtena ze souboru:', masterData.length, 'z√°znam≈Ø');
                    console.log('Prvn√≠ 3 z√°znamy:', masterData.slice(0, 3));
                    console.log('N√°zvy sloupc≈Ø:', Object.keys(masterData[0]));
                })
                .catch(error => {
                    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ze souboru:', error);
                    document.getElementById('masterStatus').innerHTML = 
                        '<div class="status warning">‚ö†Ô∏è Chyba p≈ôi naƒç√≠t√°n√≠: ' + error.message + '</div>';
                });
        }
        
        window.addEventListener('load', function() {
            loadPredefinedData();
            checkReadyToProcess();
            updateSearchButton();
            loadSearchHistory();
            loadDarkMode();
        });
        
        function updateSearchButton() {
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');
            
            if (masterData && searchInput.value.trim()) {
                searchBtn.disabled = false;
            } else {
                searchBtn.disabled = true;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', updateSearchButton);
            }
        });
        
        function updateSearchMode() {
            const toggle = document.getElementById('searchModeToggle');
            const modeDescription = document.getElementById('searchModeDescription');
            const searchInput = document.getElementById('searchInput');
            const fuzzyLabel = document.getElementById('fuzzyLabel');
            const completionLabel = document.getElementById('completionLabel');
            
            if (toggle.checked) {
                searchMode = 'completion';
                fuzzyLabel.className = 'toggle-option-label inactive';
                completionLabel.className = 'toggle-option-label active';
                completionLabel.style.color = 'white';
                completionLabel.style.background = '#28a745';
                fuzzyLabel.style.background = 'transparent';
                modeDescription.innerHTML = 'üìù Dopl≈àuje typov√© oznaƒçen√≠, vrac√≠ v≈°echny shody. Podporuje wildcard (*).';
                modeDescription.style.background = '#d4edda';
                updatePlaceholder();
            } else {
                searchMode = 'fuzzy';
                fuzzyLabel.className = 'toggle-option-label active';
                completionLabel.className = 'toggle-option-label inactive';
                fuzzyLabel.style.color = 'white';
                fuzzyLabel.style.background = '#667eea';
                completionLabel.style.background = 'transparent';
                modeDescription.innerHTML = 'üéØ Hled√° nejpodobnƒõj≈°√≠ shody, vrac√≠ top 3 v√Ωsledky';
                modeDescription.style.background = '#f0f2ff';
                updatePlaceholder();
            }
        }
        
        function setSearchMode(mode) {
            searchMode = mode;
            const fuzzyLabel = document.getElementById('fuzzyLabel');
            const combinedLabel = document.getElementById('combinedLabel');
            const completionLabel = document.getElementById('completionLabel');
            const modeDescription = document.getElementById('searchModeDescription');
            
            // Reset all
            fuzzyLabel.className = 'three-state-option inactive';
            combinedLabel.className = 'three-state-option inactive';
            completionLabel.className = 'three-state-option inactive';
            fuzzyLabel.style.background = 'transparent';
            combinedLabel.style.background = 'transparent';
            completionLabel.style.background = 'transparent';
            fuzzyLabel.style.color = '#999';
            combinedLabel.style.color = '#999';
            completionLabel.style.color = '#999';
            
            // Set active with animation
            if (mode === 'fuzzy') {
                fuzzyLabel.className = 'three-state-option active';
                fuzzyLabel.style.background = '#667eea';
                fuzzyLabel.style.color = 'white';
                modeDescription.innerHTML = 'üéØ Hled√° nejpodobnƒõj≈°√≠ shody, vrac√≠ v≈°echny v√Ωsledky';
                modeDescription.style.background = '#f0f2ff';
            } else if (mode === 'combined') {
                combinedLabel.className = 'three-state-option active';
                combinedLabel.style.background = '#6d4aff';
                combinedLabel.style.color = 'white';
                modeDescription.innerHTML = 'üéØ Kombinuje fuzzy search a wildcard (*), vrac√≠ v≈°echny shody';
                modeDescription.style.background = '#e8e3ff';
            } else if (mode === 'completion') {
                completionLabel.className = 'three-state-option active';
                completionLabel.style.background = '#28a745';
                completionLabel.style.color = 'white';
                modeDescription.innerHTML = 'üìù Dopl≈àuje typov√© oznaƒçen√≠, vrac√≠ v≈°echny shody. Podporuje wildcard (*).';
                modeDescription.style.background = '#d4edda';
            }
            
            updatePlaceholder();
        }
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('darkModeIcon');
            const isDark = document.body.classList.contains('dark-mode');
            icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDark);
        }
        
        function loadDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
            }
        }
        
        function addToHistory(term) {
            if (!term || term.trim() === '') return;
            
            // Remove if already exists
            searchHistory = searchHistory.filter(item => item !== term);
            
            // Add to beginning
            searchHistory.unshift(term);
            
            // Keep only last 10
            if (searchHistory.length > 10) {
                searchHistory = searchHistory.slice(0, 10);
            }
            
            // Save to localStorage
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            
            // Update UI
            updateHistoryUI();
        }
        
        function loadSearchHistory() {
            const saved = localStorage.getItem('searchHistory');
            if (saved) {
                searchHistory = JSON.parse(saved);
                updateHistoryUI();
            }
        }
        
        function updateHistoryUI() {
            const historyDiv = document.getElementById('searchHistory');
            const itemsDiv = document.getElementById('historyItems');
            
            if (searchHistory.length === 0) {
                historyDiv.style.display = 'none';
                return;
            }
            
            historyDiv.style.display = 'block';
            itemsDiv.innerHTML = '';
            
            searchHistory.forEach(term => {
                const item = document.createElement('span');
                item.className = 'history-item';
                item.textContent = term;
                item.onclick = () => {
                    document.getElementById('searchInput').value = term;
                    updateSearchButton();
                    searchSingle();
                };
                itemsDiv.appendChild(item);
            });
        }
        
        function clearHistory() {
            searchHistory = [];
            localStorage.removeItem('searchHistory');
            updateHistoryUI();
        }
        
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                button.textContent = '‚úì';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = 'üìã';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                alert('Chyba p≈ôi kop√≠rov√°n√≠: ' + err);
            });
        }
        
        function highlightMatch(text, searchTerm) {
            if (!text || !searchTerm) return text;
            
            // Convert to string if not already
            text = String(text);
            searchTerm = String(searchTerm);
            
            // Handle wildcards
            if (searchTerm.includes('*')) {
                // Split by * and highlight each part
                const parts = searchTerm.split('*').filter(p => p.length > 0);
                let result = text;
                
                parts.forEach(part => {
                    const searchNorm = normalizeString(part);
                    const textNorm = normalizeString(result);
                    const index = textNorm.indexOf(searchNorm);
                    
                    if (index !== -1) {
                        const before = result.substring(0, index);
                        const match = result.substring(index, index + part.length);
                        const after = result.substring(index + part.length);
                        result = `${before}<span class="highlight">${match}</span>${after}`;
                    }
                });
                
                return result;
            }
            
            const searchNorm = normalizeString(searchTerm);
            const textNorm = normalizeString(text);
            
            // Find matching substring
            const index = textNorm.indexOf(searchNorm);
            
            if (index === -1) return text;
            
            // Highlight the matching part
            const before = text.substring(0, index);
            const match = text.substring(index, index + searchTerm.length);
            const after = text.substring(index + searchTerm.length);
            
            return `${before}<span class="highlight">${match}</span>${after}`;
        }
        
        function matchesManufacturer(manufacturer, searchTerm) {
            if (!manufacturer || !searchTerm) return false;
            
            // Convert to strings
            manufacturer = String(manufacturer);
            searchTerm = String(searchTerm);
            
            const manufNorm = normalizeString(manufacturer);
            const searchNorm = normalizeString(searchTerm);
            
            // Direct match
            if (manufNorm.includes(searchNorm)) return true;
            
            // Check synonyms
            for (const [key, synonyms] of Object.entries(manufacturerSynonyms)) {
                const keyNorm = normalizeString(key);
                if (keyNorm.includes(searchNorm) || searchNorm.includes(keyNorm)) {
                    // Check if current manufacturer is in synonyms
                    return synonyms.some(syn => normalizeString(syn) === manufNorm);
                }
            }
            
            // Fuzzy match for manufacturer
            const similarity = calculateSimilarity(manufNorm, searchNorm);
            return similarity >= 70; // 70% similarity for manufacturers
        }
        
        function updateSearchField() {
            const selected = document.querySelector('input[name="searchField"]:checked');
            if (selected) {
                searchField = selected.value;
                updatePlaceholder();
            }
        }
        
        function updatePlaceholder() {
            const searchInput = document.getElementById('searchInput');
            let fieldName = '';
            
            switch(searchField) {
                case 'typ':
                    fieldName = 'typov√© oznaƒçen√≠';
                    break;
                case 'vyrobce':
                    fieldName = 'v√Ωrobce';
                    break;
                case 'nazev':
                    fieldName = 'n√°zev';
                    break;
            }
            
            if (searchMode === 'completion') {
                searchInput.placeholder = `Nap≈ô: ${fieldName === 'typov√© oznaƒçen√≠' ? 'VX, *VX*50*, 2500.*' : fieldName === 'v√Ωrobce' ? 'WAGO, *SCHALTAG*' : 'Kanal*, *SROUB*'}`;
            } else if (searchMode === 'combined') {
                searchInput.placeholder = `Zadejte ${fieldName} - podporuje wildcard (*)`;
            } else {
                searchInput.placeholder = `Zadejte ${fieldName} k vyhled√°n√≠...`;
            }
        }
        
        function wildcardToRegex(pattern) {
            // Escape special regex characters except *
            const escaped = pattern.replace(/[.+?^${}()|[\]\\]/g, '\\$&');
            // Replace * with .*
            const regex = escaped.replace(/\*/g, '.*');
            return new RegExp(regex, 'i');
        }
        
        function searchCompletion(searchTerm) {
            if (!masterData) {
                return [];
            }
            
            const firstRow = masterData[0];
            const columns = Object.keys(firstRow);
            
            // Get column names
            const typColumn = columns.find(col => 
                col.toLowerCase().includes('typ') || 
                col.toLowerCase().includes('ozna')
            ) || columns[0];
            
            const artiklColumn = columns.find(col => 
                col.toLowerCase().includes('artikl')
            ) || columns[1];
            
            const vyrobceColumn = columns.find(col => 
                col.toLowerCase().includes('v√Ωrobce') ||
                col.toLowerCase().includes('vyrobce')
            ) || columns[2];
            
            const nazevColumn = columns.find(col => 
                col.toLowerCase().includes('n√°zev') ||
                col.toLowerCase().includes('nazev')
            ) || columns[3];
            
            let matches = [];
            
            // Determine which column to search in
            let searchColumn;
            switch(searchField) {
                case 'vyrobce':
                    searchColumn = vyrobceColumn;
                    break;
                case 'nazev':
                    searchColumn = nazevColumn;
                    break;
                case 'typ':
                default:
                    searchColumn = typColumn;
                    break;
            }
            
            // Check if wildcard is used
            const hasWildcard = searchTerm.includes('*');
            
            if (hasWildcard) {
                const regex = wildcardToRegex(searchTerm);
                
                for (let row of masterData) {
                    const searchValue = String(row[searchColumn] || '');
                    
                    // Check for wildcard match
                    if (regex.test(searchValue)) {
                        matches.push({
                            artikl: row[artiklColumn],
                            foundTyp: row[typColumn],
                            vyrobce: row[vyrobceColumn] || 'N/A',
                            nazev: row[nazevColumn] || 'N/A',
                            score: 'wildcard',
                            isWildcard: true
                        });
                    }
                }
            } else {
                // Simple contains search
                const searchUpper = searchTerm.toUpperCase();
                
                for (let row of masterData) {
                    const searchValue = String(row[searchColumn] || '');
                    const searchValueUpper = searchValue.toUpperCase();
                    
                    // Check different matching strategies
                    let isMatch = false;
                    
                    if (searchField === 'vyrobce') {
                        // Use fuzzy matching for manufacturers
                        isMatch = matchesManufacturer(searchValue, searchTerm);
                    } else {
                        // Regular contains match
                        isMatch = searchValueUpper.includes(searchUpper);
                    }
                    
                    if (isMatch) {
                        matches.push({
                            artikl: row[artiklColumn],
                            foundTyp: row[typColumn],
                            vyrobce: row[vyrobceColumn] || 'N/A',
                            nazev: row[nazevColumn] || 'N/A',
                            score: 'wildcard',
                            isWildcard: true
                        });
                    }
                }
            }
            
            return matches;
        }
        
        function searchSingle() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                alert('‚ö†Ô∏è Zadejte typov√© oznaƒçen√≠ k vyhled√°n√≠');
                return;
            }
            
            if (!masterData) {
                alert('‚ö†Ô∏è Nejprve nahrajte master soubor');
                return;
            }
            
            // Add to history
            addToHistory(searchTerm);
            currentSearchTerm = searchTerm;
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.style.display = 'block';
            
            if (searchMode === 'completion') {
                // Completion mode - wildcard only
                const matches = searchCompletion(searchTerm);
                lastSearchResults = matches;
                
                if (matches.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="search-result">
                            <div class="result-header">üîç V√Ωsledky vyhled√°v√°n√≠: "${searchTerm}"</div>
                            <div class="result-item red">
                                <div class="result-row">
                                    <span class="result-label">‚ùå Nenalezena ≈æ√°dn√° shoda</span>
                                </div>
                                <button class="google-search-btn" onclick="searchGoogle('${searchTerm.replace(/'/g, "\\'")}')">
                                    üîç Vyhledat pomoc√≠ Google
                                </button>
                            </div>
                        </div>
                    `;
                    document.getElementById('manufacturerFilter').style.display = 'none';
                    return;
                }
                
                showManufacturerFilter(matches);
                displayCompletionResults(matches, searchTerm);
                
            } else if (searchMode === 'combined') {
                // Combined mode - both fuzzy and wildcard
                const wildcardMatches = searchCompletion(searchTerm);
                const fuzzyMatches = findMatch(searchTerm);
                
                // Combine and deduplicate results
                const allMatches = [...wildcardMatches];
                const seenArtikls = new Set(wildcardMatches.map(m => m.artikl));
                
                fuzzyMatches.matches.forEach(match => {
                    if (!seenArtikls.has(match.artikl)) {
                        allMatches.push(match);
                        seenArtikls.add(match.artikl);
                    }
                });
                
                lastSearchResults = allMatches;
                
                if (allMatches.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="search-result">
                            <div class="result-header">üîç V√Ωsledky vyhled√°v√°n√≠: "${searchTerm}"</div>
                            <div class="result-item red">
                                <div class="result-row">
                                    <span class="result-label">‚ùå Nenalezena ≈æ√°dn√° shoda</span>
                                </div>
                                <button class="google-search-btn" onclick="searchGoogle('${searchTerm.replace(/'/g, "\\'")}')">
                                    üîç Vyhledat pomoc√≠ Google
                                </button>
                            </div>
                        </div>
                    `;
                    document.getElementById('manufacturerFilter').style.display = 'none';
                    return;
                }
                
                showManufacturerFilter(allMatches);
                displayCombinedResults(allMatches, searchTerm);
                
            } else {
                // Fuzzy search mode - returns all matches now
                document.getElementById('manufacturerFilter').style.display = 'none';
                const matchResult = findMatch(searchTerm);
                
                if (matchResult.matches.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="search-result">
                            <div class="result-header">üîç V√Ωsledky vyhled√°v√°n√≠: "${searchTerm}"</div>
                            <div class="result-item red">
                                <div class="result-row">
                                    <span class="result-label">‚ùå Nenalezena ≈æ√°dn√° shoda</span>
                                </div>
                                <button class="google-search-btn" onclick="searchGoogle('${searchTerm.replace(/'/g, "\\'")}')">
                                    üîç Vyhledat pomoc√≠ Google
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                displayFuzzyResults(matchResult.allMatches || matchResult.matches, searchTerm);
            }
        }
        
        function showManufacturerFilter(matches) {
            // Get unique manufacturers
            const manufacturers = new Set();
            matches.forEach(match => {
                if (match.vyrobce && match.vyrobce !== 'N/A') {
                    manufacturers.add(match.vyrobce);
                }
            });
            
            // Initialize all manufacturers as selected
            selectedManufacturers = new Set(manufacturers);
            
            const filterDiv = document.getElementById('manufacturerFilter');
            const checkboxesDiv = document.getElementById('manufacturerCheckboxes');
            
            if (manufacturers.size === 0) {
                filterDiv.style.display = 'none';
                return;
            }
            
            filterDiv.style.display = 'block';
            checkboxesDiv.innerHTML = '';
            
            // Sort manufacturers alphabetically
            const sortedManufacturers = Array.from(manufacturers).sort();
            
            sortedManufacturers.forEach(manufacturer => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 5px 10px; background: white; border-radius: 6px; border: 1px solid #ddd; transition: all 0.3s; font-size: 0.85em;';
                label.onmouseover = () => label.style.background = '#f0f2ff';
                label.onmouseout = () => label.style.background = 'white';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.value = manufacturer;
                checkbox.style.cursor = 'pointer';
                checkbox.onchange = (e) => {
                    if (e.target.checked) {
                        selectedManufacturers.add(manufacturer);
                    } else {
                        selectedManufacturers.delete(manufacturer);
                    }
                };
                
                const span = document.createElement('span');
                span.textContent = manufacturer;
                span.style.fontWeight = '500';
                
                label.appendChild(checkbox);
                label.appendChild(span);
                checkboxesDiv.appendChild(label);
            });
        }
        
        function applyManufacturerFilter() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim();
            
            // Filter results based on selected manufacturers
            const filteredResults = lastSearchResults.filter(match => {
                return selectedManufacturers.has(match.vyrobce) || match.vyrobce === 'N/A';
            });
            
            displayCompletionResults(filteredResults, searchTerm);
        }
        
        function selectAllManufacturers() {
            const checkboxes = document.querySelectorAll('#manufacturerCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedManufacturers.add(checkbox.value);
            });
        }
        
        function deselectAllManufacturers() {
            const checkboxes = document.querySelectorAll('#manufacturerCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                selectedManufacturers.delete(checkbox.value);
            });
        }
        
        function updateDatabase() {
            const toggle = document.getElementById('databaseToggle');
            const toggleLabel = document.getElementById('databaseToggleLabel');
            const ustiLabel = document.getElementById('ustiLabel');
            const effiLabel = document.getElementById('effiLabel');
            
            if (toggle.checked) {
                currentDatabase = 'effretikon';
                ustiLabel.className = 'toggle-option-label inactive';
                effiLabel.className = 'toggle-option-label active';
                effiLabel.style.color = 'white';
                effiLabel.style.background = '#dc3545';
                ustiLabel.style.background = 'transparent';
                toggleLabel.style.background = '#dc3545';
            } else {
                currentDatabase = 'usti';
                ustiLabel.className = 'toggle-option-label active';
                effiLabel.className = 'toggle-option-label inactive';
                ustiLabel.style.color = 'white';
                ustiLabel.style.background = '#28a745';
                effiLabel.style.background = 'transparent';
                toggleLabel.style.background = '#28a745';
            }
            
            // Clear current data and reload with new database
            if (usingPredefinedData) {
                masterData = null;
                loadPredefinedData();
            }
        }
        
        function displayCompletionResults(matches, searchTerm) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (matches.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="search-result">
                        <div class="result-header">üîç V√Ωsledky dopl≈àov√°n√≠: "${searchTerm}" (0 v√Ωsledk≈Ø po filtrov√°n√≠)</div>
                        <div class="result-item red">
                            <div class="result-row">
                                <span class="result-label">‚ùå ≈Ω√°dn√© v√Ωsledky pro vybran√© v√Ωrobce</span>
                            </div>
                            <button class="google-search-btn" onclick="searchGoogle('${searchTerm.replace(/'/g, "\\'")}')">
                                üîç Vyhledat pomoc√≠ Google
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="search-result">
                    <div class="result-header">üîç V√Ωsledky dopl≈àov√°n√≠: "${searchTerm}" (${matches.length} ${matches.length === 1 ? 'v√Ωsledek' : matches.length < 5 ? 'v√Ωsledky' : 'v√Ωsledk≈Ø'})</div>
            `;
            
            matches.forEach((match, index) => {
                const highlightedTyp = highlightMatch(match.foundTyp, currentSearchTerm);
                const highlightedVyrobce = searchField === 'vyrobce' ? highlightMatch(match.vyrobce, currentSearchTerm) : match.vyrobce;
                const highlightedNazev = searchField === 'nazev' ? highlightMatch(match.nazev, currentSearchTerm) : match.nazev;
                
                html += `
                    <div class="result-item green">
                        <div class="result-row">
                            <span class="result-label">‚úÖ V√Ωsledek ${index + 1}:</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üì¶ Artikl:</span>
                            <span class="result-value">
                                <strong>${match.artikl || 'N/A'}</strong>
                                <button class="copy-btn" onclick="copyToClipboard('${match.artikl}', this)" title="Kop√≠rovat artikl">üìã</button>
                            </span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üè∑Ô∏è Typov√© oznaƒçen√≠:</span>
                            <span class="result-value">
                                ${highlightedTyp || 'N/A'}
                                <button class="google-mini-btn" onclick="searchGoogle('${(match.foundTyp || '').replace(/'/g, "\\'")}'); event.stopPropagation();" title="Vyhledat v Google">
                                    <span class="google-logo-mini">G</span>
                                </button>
                            </span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üè≠ V√Ωrobce:</span>
                            <span class="result-value">${highlightedVyrobce || 'N/A'}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üìù N√°zev:</span>
                            <span class="result-value">${highlightedNazev || 'N/A'}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        function searchGoogle(query) {
            if (!query || query === 'N/A') {
                alert('‚ö†Ô∏è Nelze vyhledat pr√°zdn√Ω dotaz');
                return;
            }
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            window.open(searchUrl, '_blank');
        }
        
        function displayFuzzyResults(matches, searchTerm) {
            const resultsDiv = document.getElementById('searchResults');
            
            let html = `
                <div class="search-result">
                    <div class="result-header">üîç V√Ωsledky fuzzy search: "${searchTerm}" (${matches.length} ${matches.length === 1 ? 'v√Ωsledek' : matches.length < 5 ? 'v√Ωsledky' : 'v√Ωsledk≈Ø'})</div>
            `;
            
            matches.forEach((match, index) => {
                let colorClass;
                if (match.score === 100) colorClass = 'green';
                else if (match.score >= 95) colorClass = 'yellow';
                else if (match.score >= 80) colorClass = 'orange';
                else colorClass = 'red';
                
                let matchIcon;
                if (match.score === 100) matchIcon = '‚úÖ';
                else if (match.score >= 95) matchIcon = '‚ö†Ô∏è';
                else if (match.score >= 80) matchIcon = 'üî∂';
                else matchIcon = '‚ùå';
                
                const highlightedTyp = highlightMatch(match.foundTyp, currentSearchTerm);
                
                html += `
                    <div class="result-item ${colorClass}">
                        <div class="result-row">
                            <span class="result-label">${matchIcon} Shoda ${index + 1}:</span>
                            <span class="result-value">${match.score}%</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üì¶ Artikl:</span>
                            <span class="result-value">
                                <strong>${match.artikl || 'N/A'}</strong>
                                <button class="copy-btn" onclick="copyToClipboard('${match.artikl}', this)" title="Kop√≠rovat artikl">üìã</button>
                            </span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üè∑Ô∏è Typov√© oznaƒçen√≠:</span>
                            <span class="result-value">
                                ${highlightedTyp || 'N/A'}
                                <button class="google-mini-btn" onclick="searchGoogle('${(match.foundTyp || '').replace(/'/g, "\\'")}'); event.stopPropagation();" title="Vyhledat v Google">
                                    <span class="google-logo-mini">G</span>
                                </button>
                            </span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üè≠ V√Ωrobce:</span>
                            <span class="result-value">${match.vyrobce || 'N/A'}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üìù N√°zev:</span>
                            <span class="result-value">${match.nazev || 'N/A'}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        function displayCombinedResults(matches, searchTerm) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (matches.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="search-result">
                        <div class="result-header">üîç V√Ωsledky kombinovan√©ho vyhled√°v√°n√≠: "${searchTerm}" (0 v√Ωsledk≈Ø)</div>
                        <div class="result-item red">
                            <div class="result-row">
                                <span class="result-label">‚ùå ≈Ω√°dn√© v√Ωsledky</span>
                            </div>
                            <button class="google-search-btn" onclick="searchGoogle('${searchTerm.replace(/'/g, "\\'")}')">
                                üîç Vyhledat pomoc√≠ Google
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="search-result">
                    <div class="result-header">üîç V√Ωsledky kombinovan√©ho vyhled√°v√°n√≠: "${searchTerm}" (${matches.length} ${matches.length === 1 ? 'v√Ωsledek' : matches.length < 5 ? 'v√Ωsledky' : 'v√Ωsledk≈Ø'})</div>
            `;
            
            matches.forEach((match, index) => {
                let colorClass = 'purple'; // Default for wildcard
                let matchIcon = 'üîç';
                
                // If match has score and it's not wildcard, use score-based color
                if (match.score !== undefined && match.score !== 'wildcard' && !match.isWildcard) {
                    if (match.score === 100) {
                        colorClass = 'green';
                        matchIcon = '‚úÖ';
                    } else if (match.score >= 95) {
                        colorClass = 'yellow';
                        matchIcon = '‚ö†Ô∏è';
                    } else if (match.score >= 80) {
                        colorClass = 'orange';
                        matchIcon = 'üî∂';
                    } else {
                        colorClass = 'red';
                        matchIcon = '‚ùå';
                    }
                }
                
                const highlightedTyp = searchField === 'typ' ? highlightMatch(match.foundTyp, currentSearchTerm) : match.foundTyp;
                const highlightedVyrobce = searchField === 'vyrobce' ? highlightMatch(match.vyrobce, currentSearchTerm) : match.vyrobce;
                const highlightedNazev = searchField === 'nazev' ? highlightMatch(match.nazev, currentSearchTerm) : match.nazev;
                
                html += `
                    <div class="result-item ${colorClass}">
                        <div class="result-row">
                            <span class="result-label">${matchIcon} V√Ωsledek ${index + 1}:</span>
                            ${match.score !== undefined && match.score !== 'wildcard' ? `<span class="result-value">${match.score}%</span>` : '<span class="result-value" style="font-size: 0.85em; color: #6d4aff;">Wildcard</span>'}
                        </div>
                        <div class="result-row">
                            <span class="result-label">üì¶ Artikl:</span>
                            <span class="result-value">
                                <strong>${match.artikl || 'N/A'}</strong>
                                <button class="copy-btn" onclick="copyToClipboard('${match.artikl}', this)" title="Kop√≠rovat artikl">üìã</button>
                            </span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üè∑Ô∏è Typov√© oznaƒçen√≠:</span>
                            <span class="result-value">
                                ${highlightedTyp || 'N/A'}
                                <button class="google-mini-btn" onclick="searchGoogle('${(match.foundTyp || '').replace(/'/g, "\\'")}'); event.stopPropagation();" title="Vyhledat v Google">
                                    <span class="google-logo-mini">G</span>
                                </button>
                            </span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üè≠ V√Ωrobce:</span>
                            <span class="result-value">${highlightedVyrobce || 'N/A'}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">üìù N√°zev:</span>
                            <span class="result-value">${highlightedNazev || 'N/A'}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        function handleMasterFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('masterFileName').textContent = 'üìÑ ' + file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        alert('‚ùå Soubor je pr√°zdn√Ω!');
                        return;
                    }
                    
                    // Fix Czech encoding in all string values
                    jsonData.forEach(row => {
                        Object.keys(row).forEach(key => {
                            if (typeof row[key] === 'string') {
                                row[key] = fixCzechEncoding(row[key]);
                            }
                        });
                    });
                    
                    const firstRow = jsonData[0];
                    if (!firstRow['Typov√© oznaƒçen√≠'] && !firstRow['Typov\u0082¬© ozna\u00a3\u0082¬æ en\u00a3¬≠']) {
                        alert('‚ùå Soubor mus√≠ obsahovat sloupec "Typov√© oznaƒçen√≠"!');
                        return;
                    }
                    
                    masterData = jsonData;
                    usingPredefinedData = false;
                    
                    document.getElementById('masterStatus').innerHTML = 
                        '<div class="status success">‚úÖ Master soubor √∫spƒõ≈°nƒõ nahr√°n (' + masterData.length + ' z√°znam≈Ø)</div>';
                    document.getElementById('clearMasterBtn').style.display = 'block';
                    
                    checkReadyToProcess();
                    updateSearchButton();
                } catch (error) {
                    alert('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ souboru: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function clearMasterFile() {
            const message = usingPredefinedData 
                ? 'Opravdu chcete smazat p≈ôedp≈ôipraven√° data? Budete muset nahr√°t vlastn√≠ master soubor.'
                : 'Opravdu chcete smazat nahranou vƒõdomostn√≠ z√°kladnu?';
                
            if (confirm(message)) {
                masterData = null;
                usingPredefinedData = false;
                document.getElementById('masterFileName').textContent = '';
                document.getElementById('masterStatus').innerHTML = '';
                document.getElementById('clearMasterBtn').style.display = 'none';
                document.getElementById('masterFile').value = '';
                checkReadyToProcess();
                updateSearchButton();
            }
        }
        
        function handleUserFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('userFileName').textContent = 'üìÑ ' + file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    userData = {
                        workbook: workbook,
                        fileName: file.name
                    };
                    
                    checkReadyToProcess();
                } catch (error) {
                    alert('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ souboru: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function checkReadyToProcess() {
            const btn = document.getElementById('processBtn');
            if (masterData && userData) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }
        
        function removePrefix(str) {
            if (!str) return '';
            const strUpper = String(str).toUpperCase();
            const prefixes = ['RIT.', 'SE.', 'SIE.', 'PXC.', 'FES.', 'WAGO.', 'WEI.', 'PILZ.', 'ABB.', 'SCHNE.', 'PHO.', 'EATON.', 'SICK.'];
            
            for (let prefix of prefixes) {
                if (strUpper.startsWith(prefix)) {
                    return str.substring(prefix.length);
                }
            }
            return str;
        }
        
        function normalizeString(str) {
            return String(str).toUpperCase().replace(/[.\-_\s]/g, '');
        }
        
        function calculateSimilarity(userStr, masterStr) {
            if (userStr === masterStr) return 100;
            
            const userNorm = normalizeString(userStr);
            const masterNorm = normalizeString(masterStr);
            
            if (userNorm === masterNorm) return 95;
            
            const userNoLeadZero = userNorm.replace(/^0+/, '');
            const masterNoLeadZero = masterNorm.replace(/^0+/, '');
            
            const userNoTrailZero = userNorm.replace(/0+$/, '');
            const masterNoTrailZero = masterNorm.replace(/0+$/, '');
            
            if (userNoLeadZero === masterNoLeadZero || 
                userNoTrailZero === masterNoTrailZero ||
                userNoLeadZero === masterNoTrailZero ||
                userNoTrailZero === masterNoLeadZero) {
                return 95;
            }
            
            if (userNorm.length === masterNorm.length) {
                let differences = 0;
                for (let i = 0; i < userNorm.length; i++) {
                    if (userNorm[i] !== masterNorm[i]) {
                        differences++;
                    }
                }
                
                if (differences === 1) {
                    return 85;
                } else if (differences === 2) {
                    return 70;
                }
            }
            
            const maxLen = Math.max(userNorm.length, masterNorm.length);
            if (maxLen === 0) return 100;
            
            const distance = levenshteinDistance(userNorm, masterNorm);
            const similarity = ((maxLen - distance) / maxLen) * 100;
            
            return Math.round(similarity * 10) / 10;
        }
        
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        function removeSuffix(str) {
            if (!str) return '';
            return String(str)
                .replace(/[-\s]Z\s+[A-Z0-9]+$/i, '')
                .replace(/[-\s]ZY\d+$/i, '')
                .trim();
        }
        
        function findMatch(userTyp) {
            if (!userTyp) return { 
                matches: [], 
                bestScore: 0, 
                matchType: 'red' 
            };
            
            const userTypStr = String(userTyp);
            
            if (!masterData || masterData.length === 0) {
                console.error('Master data jsou pr√°zdn√°!');
                return { 
                    matches: [], 
                    bestScore: 0, 
                    matchType: 'red' 
                };
            }
            
            let allMatches = [];
            
            const firstRow = masterData[0];
            const columns = Object.keys(firstRow);
            
            const typColumn = columns.find(col => 
                col.toLowerCase().includes('typ') || 
                col.toLowerCase().includes('ozna')
            ) || columns[0];
            
            const artiklColumn = columns.find(col => 
                col.toLowerCase().includes('artikl')
            ) || columns[1];
            
            const vyrobceColumn = columns.find(col => 
                col.toLowerCase().includes('v√Ωrobce') ||
                col.toLowerCase().includes('vyrobce')
            ) || columns[2];
            
            const nazevColumn = columns.find(col => 
                col.toLowerCase().includes('n√°zev') ||
                col.toLowerCase().includes('nazev')
            ) || columns[3];
            
            // Determine which column to search in
            let searchColumn;
            switch(searchField) {
                case 'vyrobce':
                    searchColumn = vyrobceColumn;
                    break;
                case 'nazev':
                    searchColumn = nazevColumn;
                    break;
                case 'typ':
                default:
                    searchColumn = typColumn;
                    break;
            }
            
            for (let row of masterData) {
                const masterValue = row[searchColumn];
                const masterArtikl = row[artiklColumn];
                
                if (!masterValue && !masterArtikl) continue;
                
                const masterValueStr = String(masterValue || '');
                
                let scores = [];
                
                const directScore = calculateSimilarity(userTypStr, masterValueStr);
                scores.push(directScore);
                
                // Only apply prefix/suffix logic for typov√© oznaƒçen√≠
                if (searchField === 'typ') {
                    const userNoPref = removePrefix(userTypStr);
                    const masterNoPref = removePrefix(masterValueStr);
                    
                    if (userNoPref !== userTypStr || masterNoPref !== masterValueStr) {
                        const noPrefScore = calculateSimilarity(userNoPref, masterNoPref);
                        if (noPrefScore === 100) {
                            scores.push(98);
                        } else {
                            scores.push(noPrefScore);
                        }
                    } else {
                        const noPrefScore = calculateSimilarity(userNoPref, masterNoPref);
                        scores.push(noPrefScore);
                    }
                    
                    const prefixes = ['RIT.', 'SE.', 'SIE.', 'PXC.', 'FES.', 'WAGO.', 'WEI.', 'PILZ.', 'ABB.', 'SCHNE.', 'PHO.', 'EATON.', 'SICK.'];
                    for (let prefix of prefixes) {
                        const masterUpper = masterValueStr.toUpperCase();
                        if (masterUpper.startsWith(prefix)) {
                            const withPrefixScore = calculateSimilarity(prefix + userTypStr, masterValueStr);
                            if (withPrefixScore === 100) {
                                scores.push(98);
                            } else {
                                scores.push(withPrefixScore);
                            }
                        }
                    }
                    
                    const userNoSuffix = removeSuffix(userTypStr);
                    const masterNoSuffix = removeSuffix(masterValueStr);
                    if (userNoSuffix !== userTypStr || masterNoSuffix !== masterValueStr) {
                        const noSuffixScore = calculateSimilarity(userNoSuffix, masterNoSuffix);
                        scores.push(noSuffixScore);
                    }
                }
                
                const bestScore = Math.max(...scores);
                
                if (bestScore >= 40) {
                    allMatches.push({
                        artikl: masterArtikl,
                        foundTyp: row[typColumn] || 'N/A',
                        vyrobce: row[vyrobceColumn] || 'N/A',
                        nazev: row[nazevColumn] || 'N/A',
                        score: Math.round(bestScore * 10) / 10
                    });
                }
            }
            
            allMatches.sort((a, b) => b.score - a.score);
            
            const seen = new Set();
            allMatches = allMatches.filter(match => {
                if (seen.has(match.artikl)) return false;
                seen.add(match.artikl);
                return true;
            });
            
            const topMatches = allMatches.slice(0, 3);
            
            if (topMatches.length === 0) {
                return { 
                    matches: [], 
                    allMatches: [],
                    bestScore: 0, 
                    matchType: 'red' 
                };
            }
            
            const bestScore = topMatches[0].score;
            let matchType;
            if (bestScore === 100) matchType = 'green';
            else if (bestScore >= 95) matchType = 'yellow';
            else if (bestScore >= 80) matchType = 'orange';
            else matchType = 'red';
            
            return {
                matches: topMatches,
                allMatches: allMatches, // Return all matches
                bestScore: bestScore,
                matchType: matchType
            };
        }
        
        function processFile() {
            document.getElementById('processingDiv').style.display = 'block';
            document.getElementById('processBtn').disabled = true;
            
            setTimeout(() => {
                try {
                    const workbook = userData.workbook;
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {defval: ''});
                    
                    let stats = {
                        green: 0,
                        yellow: 0,
                        orange: 0,
                        red: 0
                    };
                    
                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const userTyp = row['Typov√© oznaƒçen√≠'] || row['Typov\u0082¬© ozna\u00a3\u0082¬æ en\u00a3¬≠'];
                        
                        const matchResult = findMatch(userTyp);
                        
                        if (matchResult.matches.length > 0) {
                            for (let j = 0; j < 3; j++) {
                                if (j < matchResult.matches.length) {
                                    const match = matchResult.matches[j];
                                    row[`Shoda ${j + 1} (%)`] = match.score;
                                    row[`Artikl ${j + 1}`] = match.artikl;
                                    row[`Nalezen√© typ. ozn. ${j + 1}`] = match.foundTyp;
                                } else {
                                    row[`Shoda ${j + 1} (%)`] = '';
                                    row[`Artikl ${j + 1}`] = '';
                                    row[`Nalezen√© typ. ozn. ${j + 1}`] = '';
                                }
                            }
                            row['_matchType'] = matchResult.matchType;
                        } else {
                            row['Shoda 1 (%)'] = 0;
                            row['Artikl 1'] = '';
                            row['Nalezen√© typ. ozn. 1'] = '';
                            row['Shoda 2 (%)'] = '';
                            row['Artikl 2'] = '';
                            row['Nalezen√© typ. ozn. 2'] = '';
                            row['Shoda 3 (%)'] = '';
                            row['Artikl 3'] = '';
                            row['Nalezen√© typ. ozn. 3'] = '';
                            row['_matchType'] = 'red';
                        }
                        
                        stats[matchResult.matchType]++;
                    }
                    
                    const newWb = XLSX.utils.book_new();
                    const newWs = XLSX.utils.json_to_sheet(jsonData.map(row => {
                        const newRow = {...row};
                        delete newRow._matchType;
                        return newRow;
                    }));
                    
                    const range = XLSX.utils.decode_range(newWs['!ref']);
                    
                    for (let R = range.s.r + 1; R <= range.e.r; R++) {
                        const matchType = jsonData[R - 1]._matchType;
                        let fillColor;
                        
                        switch(matchType) {
                            case 'green': fillColor = '90EE90'; break;
                            case 'yellow': fillColor = 'FFFF00'; break;
                            case 'orange': fillColor = 'FFA500'; break;
                            case 'red': fillColor = 'FF6B6B'; break;
                        }
                        
                        if (fillColor) {
                            for (let C = range.s.c; C <= range.e.c; C++) {
                                const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                                if (!newWs[cellAddress]) {
                                    newWs[cellAddress] = {t: 's', v: ''};
                                }
                                if (!newWs[cellAddress].s) newWs[cellAddress].s = {};
                                newWs[cellAddress].s.fgColor = {rgb: fillColor};
                                newWs[cellAddress].s.fill = {
                                    patternType: 'solid',
                                    fgColor: {rgb: fillColor}
                                };
                            }
                        }
                    }
                    
                    XLSX.utils.book_append_sheet(newWb, newWs, 'Data');
                    
                    const fileName = userData.fileName.replace(/\.xlsx?$/i, '_doplneno.xlsx');
                    XLSX.writeFile(newWb, fileName, {cellStyles: true});
                    
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('resultsInfo').innerHTML = 
                        `<strong>‚úÖ Soubor zpracov√°n a sta≈æen!</strong><br><br>` +
                        `üìä Statistika:<br>` +
                        `üü¢ P≈ôesn√© shody (100%): ${stats.green}<br>` +
                        `üü° Normalizovan√© (95%+): ${stats.yellow}<br>` +
                        `üü† Mal√© rozd√≠ly (80-94%): ${stats.orange}<br>` +
                        `üî¥ ƒå√°steƒçn√°/nenalezeno (&lt;80%): ${stats.red}`;
                    
                } catch (error) {
                    alert('‚ùå Chyba p≈ôi zpracov√°n√≠: ' + error.message);
                    console.error(error);
                } finally {
                    document.getElementById('processingDiv').style.display = 'none';
                    document.getElementById('processBtn').disabled = false;
                }
            }, 500);
        }
    </script>
</body>
</html>